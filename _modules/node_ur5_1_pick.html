

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>node_ur5_1_pick &mdash; eYRC VB#0574 Task 5 1.0 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> eYRC VB#0574 Task 5
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../rst/software_specs.html">1. Software Specifications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rst/installations.html">2. Insatllations</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../rst/installations/rosmelodic.html">2.1. ROS Installation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../rst/installations/rosmelodic.html#installation-instruction">2.1.1. Installation Instruction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rst/installations/rosmelodic.html#ros-melodic-installation">2.1.2. ROS Melodic Installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rst/installations/rosmelodic.html#installation-steps">2.1.3. Installation Steps</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rst/installations/rosmelodic.html#configuration-steps">2.1.4. Configuration Steps</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rst/installations/rosmelodic.html#additional-packages-to-install">2.1.5. Additional packages to install</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rst/installations/rosmelodic.html#references">2.1.6. References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../rst/installations/moveit.html">2.2. MoveIt! for ROS Melodic</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rst/installations/vbsimpkg.html">2.3. Vargi Bots Simulation Packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rst/installations/pahomqtt.html">2.4. Paho MQTT Library</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../rst/installations/pahomqtt.html#installation-instruction">2.4.1. Installation Instruction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rst/installations/pahomqtt.html#example-mqtt-pub-sub">2.4.2. Example MQTT Pub-Sub</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../rst/installations/pahomqtt.html#sub-py">2.4.2.1. sub.py</a></li>
<li class="toctree-l4"><a class="reference internal" href="../rst/installations/pahomqtt.html#pub-py">2.4.2.2. pub.py</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../rst/installations/pahomqtt.html#references">2.4.3. References</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../rst/introduction.html">3. Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../rst/introduction.html#overview">3.1. Overview</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../rst/introduction.html#strategies-used-to-save-time">3.1.1. Strategies used to save time</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../rst/introduction.html#video-demonstration">3.2. Video Demonstration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../rst/implementation.html">4. Implementation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../rst/implementation.html#setting-up-gazebo-and-planning-scene">4.1. Setting up Gazebo and Planning Scene</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rst/implementation.html#saving-trajectories">4.2. Saving Trajectories</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../rst/implementation.html#determining-execution-time">4.2.1. Determining Execution Time</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rst/implementation.html#automate-trajectory-saving">4.2.2. Automate Trajectory Saving</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../rst/implementation.html#qr-detection">4.3. QR Detection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rst/implementation.html#ros-iot-bridge-setup">4.4. Ros-IoT Bridge Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rst/implementation.html#order-handling">4.5. Order Handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rst/implementation.html#picking-up-packages-from-shelf">4.6. Picking Up Packages From Shelf</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rst/implementation.html#placing-packages-in-the-bin">4.7. Placing Packages in the Bin</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../rst/implementation.html#when-ur5-2-arm-is-free">4.7.1. When UR5#2 arm is free</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rst/implementation.html#when-ur5-2-arm-is-busy">4.7.2. When UR5#2 arm is busy</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../rst/implementation.html#dashboard">4.8. Dashboard</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../rst/implementation.html#map">4.8.1. Map</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rst/implementation.html#table">4.8.2. Table</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rst/implementation.html#bar-graph">4.8.3. Bar Graph</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../rst/implementation.html#rqt-graph">4.9. RQT Graph</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../rst/api_documentation.html">5. API Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../rst/api_documentation.html#package-task-5">5.1. Package Task 5</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../rst/pkg_task5/python_scripts.html">5.1.1. Python Scripts</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../rst/pkg_task5/scripts/node_ur5_1_pick.html">5.1.1.1. node_ur5_1_pick</a></li>
<li class="toctree-l4"><a class="reference internal" href="../rst/pkg_task5/scripts/node_ur5_2_place.html">5.1.1.2. node_ur5_2_place</a></li>
<li class="toctree-l4"><a class="reference internal" href="../rst/pkg_task5/scripts/incoming_order_handler.html">5.1.1.3. incoming_order_handler</a></li>
<li class="toctree-l4"><a class="reference internal" href="../rst/pkg_task5/scripts/qr/qr_decode.html">5.1.1.4. qr/qr_decode</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../rst/pkg_task5/msg_files.html">5.1.2. Message Files</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../rst/pkg_task5/msg/Camera1Image.html">5.1.2.1. Camera1Image.msg</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../rst/pkg_task5/msg/Camera1Image.html#description">5.1.2.1.1. Description</a></li>
<li class="toctree-l5"><a class="reference internal" href="../rst/pkg_task5/msg/Camera1Image.html#parameters">5.1.2.1.2. Parameters</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../rst/pkg_task5/msg/DispatchedPackage.html">5.1.2.2. DispatchedPackage.msg</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../rst/pkg_task5/msg/DispatchedPackage.html#description">5.1.2.2.1. Description</a></li>
<li class="toctree-l5"><a class="reference internal" href="../rst/pkg_task5/msg/DispatchedPackage.html#parameters">5.1.2.2.2. Parameters</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../rst/pkg_task5/msg/NewOrder.html">5.1.2.3. NewOrder.msg</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../rst/pkg_task5/msg/NewOrder.html#description">5.1.2.3.1. Description</a></li>
<li class="toctree-l5"><a class="reference internal" href="../rst/pkg_task5/msg/NewOrder.html#parameters">5.1.2.3.2. Parameters</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../rst/pkg_task5/launch_files.html">5.1.3. Launch Files</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../rst/pkg_task5/launch/task5_solution.html">5.1.3.1. task5_solution.launch</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../rst/pkg_task5/launch/task5_solution.html#description">5.1.3.1.1. Description</a></li>
<li class="toctree-l5"><a class="reference internal" href="../rst/pkg_task5/launch/task5_solution.html#job">5.1.3.1.2. Job</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../rst/pkg_task5/YAML_files.html">5.1.4. YAML Files</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../rst/pkg_task5/config/saved_trajectories/home1_to_xxx_bin.html">5.1.4.1. home1_to_xxx_bin.yaml</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../rst/pkg_task5/config/saved_trajectories/home1_to_xxx_bin.html#description">5.1.4.1.1. Description</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../rst/pkg_task5/config/saved_trajectories/home2_to_xxx_bin.html">5.1.4.2. home2_to_xxx_bin.yaml</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../rst/pkg_task5/config/saved_trajectories/home2_to_xxx_bin.html#description">5.1.4.2.1. Description</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../rst/pkg_task5/config/saved_trajectories/home_to_pkgnxx.html">5.1.4.3. home_to_pkgn<em>xx</em>.yaml</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../rst/pkg_task5/config/saved_trajectories/home_to_pkgnxx.html#description">5.1.4.3.1. Description</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../rst/pkg_task5/config/saved_trajectories/pkgnxx_to_home.html">5.1.4.4. pkgn<em>xx</em>_to_home.yaml</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../rst/pkg_task5/config/saved_trajectories/pkgnxx_to_home.html#description">5.1.4.4.1. Description</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../rst/api_documentation.html#package-ros-iot-bridge">5.2. Package Ros-IoT Bridge</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../rst/pkg_ros_iot_bridge/python_scripts.html">5.2.1. Python Scripts</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../rst/pkg_ros_iot_bridge/scripts/node_action_server_ros_iot_bridge.html">5.2.1.1. node_action_server_ros_iot_bridge</a></li>
<li class="toctree-l4"><a class="reference internal" href="../rst/pkg_ros_iot_bridge/scripts/pyiot/iot.html">5.2.1.2. pyiot/iot</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../rst/pkg_ros_iot_bridge/msg_files.html">5.2.2. Message Files</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../rst/pkg_ros_iot_bridge/msg/msgMqttSub.html">5.2.2.1. msgMqttSub.msg</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../rst/pkg_ros_iot_bridge/msg/msgMqttSub.html#description">5.2.2.1.1. Description</a><ul>
<li class="toctree-l6"><a class="reference internal" href="../rst/pkg_ros_iot_bridge/msg/msgMqttSub.html#parameters">5.2.2.1.1.1. Parameters</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../rst/pkg_ros_iot_bridge/action_files.html">5.2.3. Action Files</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../rst/pkg_ros_iot_bridge/action/msgRosIot.html">5.2.3.1. msgRosIot.action</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../rst/pkg_ros_iot_bridge/action/msgRosIot.html#description">5.2.3.1.1. Description</a></li>
<li class="toctree-l5"><a class="reference internal" href="../rst/pkg_ros_iot_bridge/action/msgRosIot.html#parameters">5.2.3.1.2. Parameters</a><ul>
<li class="toctree-l6"><a class="reference internal" href="../rst/pkg_ros_iot_bridge/action/msgRosIot.html#goal">5.2.3.1.2.1. Goal</a></li>
<li class="toctree-l6"><a class="reference internal" href="../rst/pkg_ros_iot_bridge/action/msgRosIot.html#feedback">5.2.3.1.2.2. Feedback</a></li>
<li class="toctree-l6"><a class="reference internal" href="../rst/pkg_ros_iot_bridge/action/msgRosIot.html#result">5.2.3.1.2.3. Result</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../rst/pkg_ros_iot_bridge/config_files.html">5.2.4. Config Files</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../rst/pkg_ros_iot_bridge/config/config_pyiot.html">5.2.4.1. config_pyiot.yaml</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../rst/pkg_ros_iot_bridge/config/config_pyiot.html#description">5.2.4.1.1. Description</a></li>
<li class="toctree-l5"><a class="reference internal" href="../rst/pkg_ros_iot_bridge/config/config_pyiot.html#parameters">5.2.4.1.2. Parameters</a><ul>
<li class="toctree-l6"><a class="reference internal" href="../rst/pkg_ros_iot_bridge/config/config_pyiot.html#mqtt">5.2.4.1.2.1. MQTT</a></li>
<li class="toctree-l6"><a class="reference internal" href="../rst/pkg_ros_iot_bridge/config/config_pyiot.html#google-apps">5.2.4.1.2.2. Google Apps</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">eYRC VB#0574 Task 5</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>node_ur5_1_pick</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for node_ur5_1_pick</h1><div class="highlight"><pre>
<span></span><span class="ch">#! /usr/bin/env python</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">ROS Node for UR5_1 arm to pick packages from shelf and place them on conveyor belt.</span>

<span class="sd">At first, the colour of the packages are detected by importing the qr node. Then the inventory</span>
<span class="sd">sheet is updated by sending a goal to the action server. After that whenever a new order is</span>
<span class="sd">placed on the MQTT topic &quot;/eyrc/vb/isPicuTP/orders&quot;, it is appended to a local list. This list is</span>
<span class="sd">sorted according to the priority of the orders and then the order  at the top of list is processed</span>
<span class="sd">and picked up from the shelf and placed on conveyor belt. The details of the dispatched order are</span>
<span class="sd">than updated in the &quot;DispatchedOrder&quot; sheet by sending a goal to the action server.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="kn">import</span> <span class="nn">rospy</span>
<span class="kn">import</span> <span class="nn">moveit_commander</span>
<span class="kn">import</span> <span class="nn">moveit_msgs.msg</span>
<span class="kn">import</span> <span class="nn">actionlib</span>
<span class="kn">import</span> <span class="nn">rospkg</span>
<span class="kn">import</span> <span class="nn">yaml</span>

<span class="kn">from</span> <span class="nn">pkg_vb_sim.srv</span> <span class="kn">import</span> <span class="n">conveyorBeltPowerMsg</span>

<span class="kn">from</span> <span class="nn">pkg_vb_sim.srv</span> <span class="kn">import</span> <span class="n">vacuumGripper</span>

<span class="kn">from</span> <span class="nn">pkg_task5.msg</span> <span class="kn">import</span> <span class="n">Camera1Image</span>
<span class="kn">from</span> <span class="nn">pkg_task5.msg</span> <span class="kn">import</span> <span class="n">DispatchedPackage</span>
<span class="kn">from</span> <span class="nn">pkg_task5.msg</span> <span class="kn">import</span> <span class="n">NewOrder</span>

<span class="kn">from</span> <span class="nn">pkg_ros_iot_bridge.msg</span> <span class="kn">import</span> <span class="n">msgRosIotAction</span>
<span class="kn">from</span> <span class="nn">pkg_ros_iot_bridge.msg</span> <span class="kn">import</span> <span class="n">msgRosIotGoal</span>

<span class="kn">from</span> <span class="nn">qr</span> <span class="kn">import</span> <span class="n">qr_decode</span>


<div class="viewcode-block" id="Ur5Moveit"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_1_pick.html#node_ur5_1_pick.Ur5Moveit">[docs]</a><span class="k">class</span> <span class="nc">Ur5Moveit</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize necessary objects to operate a UR5 arm</span>

<span class="sd">    Initialize trajectory publisher, execute client, planning scene interface,</span>
<span class="sd">    move group commander, vacuum gripper service and other necessary things</span>
<span class="sd">    for proper interface of Ur5 arm with Gazebo, MoveIt! and RViz</span>

<span class="sd">    :param arg_robot_name: Name of Ur5 arm to control</span>
<span class="sd">    :type arg_robot_name: str</span>

<span class="sd">    :Example:</span>

<span class="sd">    ur5_1 = Ur5Moveit(&#39;ur5_1&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># pylint: disable=too-many-instance-attributes</span>

    <span class="c1"># Constructor</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_robot_name</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_robot_ns</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">arg_robot_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_planning_group</span> <span class="o">=</span> <span class="s2">&quot;manipulator&quot;</span>

        <span class="n">moveit_commander</span><span class="o">.</span><span class="n">roscpp_initialize</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_robot</span> <span class="o">=</span> <span class="n">moveit_commander</span><span class="o">.</span><span class="n">RobotCommander</span><span class="p">(</span><span class="n">robot_description</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_robot_ns</span> <span class="o">+</span>
                                                      <span class="s2">&quot;/robot_description&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_robot_ns</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scene</span> <span class="o">=</span> <span class="n">moveit_commander</span><span class="o">.</span><span class="n">PlanningSceneInterface</span><span class="p">(</span><span class="n">ns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_robot_ns</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_group</span> <span class="o">=</span> <span class="n">moveit_commander</span><span class="o">.</span><span class="n">MoveGroupCommander</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_planning_group</span><span class="p">,</span>
                                                          <span class="n">robot_description</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_robot_ns</span> <span class="o">+</span>
                                                          <span class="s2">&quot;/robot_description&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_robot_ns</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_display_trajectory_publisher</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_robot_ns</span> <span class="o">+</span>
                                                             <span class="s1">&#39;/move_group/display_planned_path&#39;</span><span class="p">,</span>
                                                             <span class="n">moveit_msgs</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">DisplayTrajectory</span><span class="p">,</span>
                                                             <span class="n">queue_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_execute_trajectory_client</span> <span class="o">=</span> <span class="n">actionlib</span><span class="o">.</span><span class="n">SimpleActionClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_robot_ns</span> <span class="o">+</span>
                                                                       <span class="s1">&#39;/execute_trajectory&#39;</span><span class="p">,</span>
                                                                       <span class="n">moveit_msgs</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span>
                                                                       <span class="n">ExecuteTrajectoryAction</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_execute_trajectory_client</span><span class="o">.</span><span class="n">wait_for_server</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_planning_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="o">.</span><span class="n">get_planning_frame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eef_link</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="o">.</span><span class="n">get_end_effector_link</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_group_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_robot</span><span class="o">.</span><span class="n">get_group_names</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_box_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vacuum_gripper_service</span> <span class="o">=</span> <span class="s1">&#39;/eyrc/vb/ur5/activate_vacuum_gripper/&#39;</span> <span class="o">+</span> <span class="n">arg_robot_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_computed_plan</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="n">ros_pkg</span> <span class="o">=</span> <span class="n">rospkg</span><span class="o">.</span><span class="n">RosPack</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pkg_path</span> <span class="o">=</span> <span class="n">ros_pkg</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s1">&#39;pkg_task5&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pkg_path</span> <span class="o">+</span> <span class="s1">&#39;/config/saved_trajectories/&#39;</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s2">&quot;Package Path: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file_path</span><span class="p">))</span>

        <span class="c1"># Current State of the Robot is needed to add box to planning scene</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_curr_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_robot</span><span class="o">.</span><span class="n">get_current_state</span><span class="p">()</span>

        <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[94m&#39;</span> <span class="o">+</span> <span class="s2">&quot;Planning Group: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_planning_frame</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[94m&#39;</span> <span class="o">+</span> <span class="s2">&quot;End Effector Link: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_eef_link</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[94m&#39;</span> <span class="o">+</span> <span class="s2">&quot;Group Names: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_group_names</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span>

        <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[94m&#39;</span> <span class="o">+</span> <span class="s2">&quot; &gt;&gt;&gt; Ur5Moveit init done.&quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Ur5Moveit.go_to_pose"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_1_pick.html#node_ur5_1_pick.Ur5Moveit.go_to_pose">[docs]</a>    <span class="k">def</span> <span class="nf">go_to_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_pose</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make the vacuum gripper go to a certain position in space</span>

<span class="sd">        :param arg_pose: goal pose of the vacuum gripper</span>
<span class="sd">        :type arg_pose: geometry_msgs.msg.Pose()</span>
<span class="sd">        :return: Success flag</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="o">.</span><span class="n">set_pose_target</span><span class="p">(</span><span class="n">arg_pose</span><span class="p">)</span>
        <span class="n">flag_plan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="o">.</span><span class="n">go</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># wait=False for Async Move</span>

        <span class="k">return</span> <span class="n">flag_plan</span></div>

<div class="viewcode-block" id="Ur5Moveit.hard_go_to_pose"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_1_pick.html#node_ur5_1_pick.Ur5Moveit.hard_go_to_pose">[docs]</a>    <span class="k">def</span> <span class="nf">hard_go_to_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_pose</span><span class="p">,</span> <span class="n">arg_max_attempts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Try going to a pose again and until success or max attempts exhausted</span>

<span class="sd">        :param arg_pose: goal pose of the vacuum gripper</span>
<span class="sd">        :type arg_pose: geometry_msgs.msg.Pose()</span>
<span class="sd">        :param arg_max_attempts: maximum number of attempts to try</span>
<span class="sd">        :type arg_max_attempts: int</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">number_attempts</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">flag_success</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">while</span> <span class="n">number_attempts</span> <span class="o">&lt;=</span> <span class="n">arg_max_attempts</span> <span class="ow">and</span> <span class="n">flag_success</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">number_attempts</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">flag_success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">go_to_pose</span><span class="p">(</span><span class="n">arg_pose</span><span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="s2">&quot;attempts: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number_attempts</span><span class="p">))</span></div>

<div class="viewcode-block" id="Ur5Moveit.set_joint_angles"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_1_pick.html#node_ur5_1_pick.Ur5Moveit.set_joint_angles">[docs]</a>    <span class="k">def</span> <span class="nf">set_joint_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list_joint_angles</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set joint angles of arm to pre defined joint angles</span>

<span class="sd">        :param arg_list_joint_angles: list of goal joint angles of UR5 arm in radians</span>
<span class="sd">        :type arg_list_joint_angles: list</span>
<span class="sd">        :return: Success flag</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="o">.</span><span class="n">set_joint_value_target</span><span class="p">(</span><span class="n">arg_list_joint_angles</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_computed_plan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="o">.</span><span class="n">plan</span><span class="p">()</span>
        <span class="n">flag_plan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_computed_plan</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">flag_plan</span></div>

<div class="viewcode-block" id="Ur5Moveit.hard_set_joint_angles"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_1_pick.html#node_ur5_1_pick.Ur5Moveit.hard_set_joint_angles">[docs]</a>    <span class="k">def</span> <span class="nf">hard_set_joint_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list_joint_angles</span><span class="p">,</span> <span class="n">arg_max_attempts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Try to set the joint angles again and again until success or max attempts exhausted</span>

<span class="sd">        :param arg_list_joint_angles: list of goal joint angles of UR5 arm in radians</span>
<span class="sd">        :type arg_list_joint_angles: list</span>
<span class="sd">        :param arg_max_attempts: maximum number of attempts to try</span>
<span class="sd">        :type arg_max_attempts: int</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">number_attempts</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">flag_success</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">while</span> <span class="n">number_attempts</span> <span class="o">&lt;=</span> <span class="n">arg_max_attempts</span> <span class="ow">and</span> <span class="n">flag_success</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">number_attempts</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">flag_success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_joint_angles</span><span class="p">(</span><span class="n">arg_list_joint_angles</span><span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="s2">&quot;attempts: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number_attempts</span><span class="p">))</span></div>

<div class="viewcode-block" id="Ur5Moveit.attach_box"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_1_pick.html#node_ur5_1_pick.Ur5Moveit.attach_box">[docs]</a>    <span class="k">def</span> <span class="nf">attach_box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">box_name</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attach box received in arguments to arm in RViz</span>

<span class="sd">        :param box_name: name of box to attach</span>
<span class="sd">        :type box_name: str</span>
<span class="sd">        :param timeout: time(s) to wait for state update else return False</span>
<span class="sd">        :type timeout: int</span>
<span class="sd">        :return: Success Flag</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">grasping_group</span> <span class="o">=</span> <span class="s1">&#39;manipulator&#39;</span>
        <span class="n">touch_links</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_robot</span><span class="o">.</span><span class="n">get_link_names</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="n">grasping_group</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scene</span><span class="o">.</span><span class="n">attach_box</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_eef_link</span><span class="p">,</span> <span class="n">box_name</span><span class="p">,</span> <span class="n">touch_links</span><span class="o">=</span><span class="n">touch_links</span><span class="p">)</span>

        <span class="c1"># We wait for the planning scene to update.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_state_update</span><span class="p">(</span><span class="n">box_is_attached</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">box_is_known</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span></div>

<div class="viewcode-block" id="Ur5Moveit.detach_box"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_1_pick.html#node_ur5_1_pick.Ur5Moveit.detach_box">[docs]</a>    <span class="k">def</span> <span class="nf">detach_box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">box_name</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Detach box received in arguments to arm in RViz</span>

<span class="sd">        :param box_name: name of box to detach</span>
<span class="sd">        :type box_name: str</span>
<span class="sd">        :param timeout: time(s) to wait for state update else return False</span>
<span class="sd">        :type timeout: int</span>
<span class="sd">        :return: Success Flag</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scene</span><span class="o">.</span><span class="n">remove_attached_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_eef_link</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">box_name</span><span class="p">)</span>

        <span class="c1"># We wait for the planning scene to update.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_state_update</span><span class="p">(</span><span class="n">box_is_known</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">box_is_attached</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span></div>

<div class="viewcode-block" id="Ur5Moveit.attach_box_in_gazebo"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_1_pick.html#node_ur5_1_pick.Ur5Moveit.attach_box_in_gazebo">[docs]</a>    <span class="k">def</span> <span class="nf">attach_box_in_gazebo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Activate vacuum gripper of arm in gazebo</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">wait_for_service</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vacuum_gripper_service</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">activate_vacuum_gripper</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceProxy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vacuum_gripper_service</span><span class="p">,</span> <span class="n">vacuumGripper</span><span class="p">)</span>
            <span class="n">resp1</span> <span class="o">=</span> <span class="n">activate_vacuum_gripper</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">resp1</span><span class="o">.</span><span class="n">result</span>
        <span class="k">except</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceException</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Service call failed: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">exception</span><span class="p">)</span></div>

<div class="viewcode-block" id="Ur5Moveit.detach_box_in_gazebo"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_1_pick.html#node_ur5_1_pick.Ur5Moveit.detach_box_in_gazebo">[docs]</a>    <span class="k">def</span> <span class="nf">detach_box_in_gazebo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deactivate vacuum gripper of arm in gazebo</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">wait_for_service</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vacuum_gripper_service</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">activate_vacuum_gripper</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceProxy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vacuum_gripper_service</span><span class="p">,</span> <span class="n">vacuumGripper</span><span class="p">)</span>
            <span class="n">resp1</span> <span class="o">=</span> <span class="n">activate_vacuum_gripper</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">resp1</span><span class="o">.</span><span class="n">result</span>
        <span class="k">except</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceException</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Service call failed: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">exception</span><span class="p">)</span></div>

<div class="viewcode-block" id="Ur5Moveit.remove_box"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_1_pick.html#node_ur5_1_pick.Ur5Moveit.remove_box">[docs]</a>    <span class="k">def</span> <span class="nf">remove_box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">box_name</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove box from planning scene in RViz</span>

<span class="sd">        :param box_name: name of box to remove</span>
<span class="sd">        :type box_name: str</span>
<span class="sd">        :param timeout: time(s) to wait for state update else return False</span>
<span class="sd">        :type timeout: int</span>
<span class="sd">        :return: Success flag</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scene</span><span class="o">.</span><span class="n">remove_world_object</span><span class="p">(</span><span class="n">box_name</span><span class="p">)</span>

        <span class="c1"># We wait for the planning scene to update.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_state_update</span><span class="p">(</span><span class="n">box_is_attached</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                          <span class="n">box_is_known</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span></div>

<div class="viewcode-block" id="Ur5Moveit.wait_for_state_update"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_1_pick.html#node_ur5_1_pick.Ur5Moveit.wait_for_state_update">[docs]</a>    <span class="k">def</span> <span class="nf">wait_for_state_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">box_is_known</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">box_is_attached</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wait before all the required changes are made in the planning scene in RViz</span>

<span class="sd">        :param box_is_known: Flag whether the box is present in planning scene or not</span>
<span class="sd">        :type box_is_known: bool</span>
<span class="sd">        :param box_is_attached: flag whether the box is attached to arm or not in RViz</span>
<span class="sd">        :type box_is_attached: bool</span>
<span class="sd">        :param timeout: time(s) to wait for the state to update</span>
<span class="sd">        :type timeout: int</span>
<span class="sd">        :return: success flag</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">()</span>
        <span class="n">seconds</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">()</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">seconds</span> <span class="o">-</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">rospy</span><span class="o">.</span><span class="n">is_shutdown</span><span class="p">():</span>
            <span class="c1"># Test if the box is in attached objects</span>
            <span class="n">attached_objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scene</span><span class="o">.</span><span class="n">get_attached_objects</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_box_name</span><span class="p">])</span>

            <span class="n">is_attached</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">attached_objects</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="c1"># Test if the box is in the scene.</span>
            <span class="c1"># Note that attaching the box will remove it from known_objects</span>
            <span class="n">is_known</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_box_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scene</span><span class="o">.</span><span class="n">get_known_object_names</span><span class="p">()</span>

            <span class="c1"># Test if we are in the expected state</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">box_is_attached</span> <span class="o">==</span> <span class="n">is_attached</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">box_is_known</span> <span class="o">==</span> <span class="n">is_known</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>

            <span class="c1"># Sleep so that we give other threads time on the processor</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">seconds</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">()</span>

        <span class="c1"># If we exited the while loop without returning then we timed out</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Ur5Moveit.play_saved_trajectory"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_1_pick.html#node_ur5_1_pick.Ur5Moveit.play_saved_trajectory">[docs]</a>    <span class="k">def</span> <span class="nf">play_saved_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trajectory</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Play a trajectory which was saved before</span>

<span class="sd">        :param trajectory: Trajectory to be played</span>
<span class="sd">        :type trajectory: JointTrajectory</span>
<span class="sd">        :return: success flag</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">trajectory</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="Ur5Moveit.hard_play_saved_trajectory"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_1_pick.html#node_ur5_1_pick.Ur5Moveit.hard_play_saved_trajectory">[docs]</a>    <span class="k">def</span> <span class="nf">hard_play_saved_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trajectory</span><span class="p">,</span> <span class="n">arg_max_attempts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Try playing a trajectory again and again until success or max attempts exhausted</span>

<span class="sd">        :param trajectory: Trajectory to be played</span>
<span class="sd">        :type trajectory: JointTrajectory</span>
<span class="sd">        :param arg_max_attempts: Max number of attempts to try again in case of failure</span>
<span class="sd">        :type arg_max_attempts: int</span>
<span class="sd">        :return: success flag</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">number_attempts</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">flag_success</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">while</span> <span class="n">number_attempts</span> <span class="o">&lt;=</span> <span class="n">arg_max_attempts</span> <span class="ow">and</span> <span class="n">flag_success</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">number_attempts</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">flag_success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">play_saved_trajectory</span><span class="p">(</span><span class="n">trajectory</span><span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="s2">&quot;attempts: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number_attempts</span><span class="p">))</span>

        <span class="k">return</span> <span class="kc">True</span></div>

    <span class="c1"># Destructor</span>
    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">moveit_commander</span><span class="o">.</span><span class="n">roscpp_shutdown</span><span class="p">()</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[94m&#39;</span> <span class="o">+</span> <span class="s2">&quot;Object of class Ur5Moveit Deleted.&quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ShelfCamera"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_1_pick.html#node_ur5_1_pick.ShelfCamera">[docs]</a><span class="k">class</span> <span class="nc">ShelfCamera</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Store information regarding colour of packages on shelf as recognised by the 2D Camera</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_sub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Subscriber</span><span class="p">(</span><span class="s2">&quot;eyrc/package/colours&quot;</span><span class="p">,</span> <span class="n">Camera1Image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_callback</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pkg_colour_list</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;NA&#39;</span> <span class="k">for</span> <span class="n">_column</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span> <span class="k">for</span> <span class="n">_row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span>

<div class="viewcode-block" id="ShelfCamera.get_pkg_colour"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_1_pick.html#node_ur5_1_pick.ShelfCamera.get_pkg_colour">[docs]</a>    <span class="k">def</span> <span class="nf">get_pkg_colour</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return colour of package present on specific row and column</span>

<span class="sd">        :param row: row of package</span>
<span class="sd">        :type row: int</span>
<span class="sd">        :param column: column of package</span>
<span class="sd">        :type column: int</span>
<span class="sd">        :return: list of colour of all the packages present on shelf</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkg_colour_list</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">column</span><span class="p">]</span></div>

<div class="viewcode-block" id="ShelfCamera.sub_callback"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_1_pick.html#node_ur5_1_pick.ShelfCamera.sub_callback">[docs]</a>    <span class="k">def</span> <span class="nf">sub_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">camera_image</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update colour of packages in the local list identified by the 2D Camera</span>

<span class="sd">        :param camera_image: information of all the packages seen by the camera</span>
<span class="sd">        :type camera_image: Camera1Image</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="c1"># Update local list of colour of all the packages present on the shelf</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pkg_colour_list</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">camera_image</span><span class="o">.</span><span class="n">pkg_colour</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">row</span> <span class="o">+</span> <span class="n">column</span><span class="p">]</span></div>

<div class="viewcode-block" id="ShelfCamera.print_colours"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_1_pick.html#node_ur5_1_pick.ShelfCamera.print_colours">[docs]</a>    <span class="k">def</span> <span class="nf">print_colours</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print colour of all the packages present on the shelf with their name(row and column).</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;package&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">column</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkg_colour_list</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">column</span><span class="p">])</span></div>

<div class="viewcode-block" id="ShelfCamera.get_pkg_colour_list"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_1_pick.html#node_ur5_1_pick.ShelfCamera.get_pkg_colour_list">[docs]</a>    <span class="k">def</span> <span class="nf">get_pkg_colour_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return list of colour of all the packages present on the shelf</span>

<span class="sd">        :return: List of colour of all the packages present on the shelf</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkg_colour_list</span></div></div>


<div class="viewcode-block" id="DispatchedPkg"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_1_pick.html#node_ur5_1_pick.DispatchedPkg">[docs]</a><span class="k">class</span> <span class="nc">DispatchedPkg</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Class to store name and colour of the dispatched package&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;NA&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">colour</span> <span class="o">=</span> <span class="s1">&#39;NA&#39;</span>

<div class="viewcode-block" id="DispatchedPkg.set_name"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_1_pick.html#node_ur5_1_pick.DispatchedPkg.set_name">[docs]</a>    <span class="k">def</span> <span class="nf">set_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set name of the dispatched package</span>

<span class="sd">        :param name: name of the package</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span></div>

<div class="viewcode-block" id="DispatchedPkg.set_colour"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_1_pick.html#node_ur5_1_pick.DispatchedPkg.set_colour">[docs]</a>    <span class="k">def</span> <span class="nf">set_colour</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colour</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set colour of the dispatched package</span>

<span class="sd">        :param colour: colour of the package</span>
<span class="sd">        :type colour: str</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">colour</span> <span class="o">=</span> <span class="n">colour</span></div></div>


<div class="viewcode-block" id="RosIotBridgeActionClient"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_1_pick.html#node_ur5_1_pick.RosIotBridgeActionClient">[docs]</a><span class="k">class</span> <span class="nc">RosIotBridgeActionClient</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Action Client to act as a bridge between ROS Nodes and IOT to update</span>
<span class="sd">    google spreadsheets</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Constructor</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># Initialize Action Client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ac</span> <span class="o">=</span> <span class="n">actionlib</span><span class="o">.</span><span class="n">ActionClient</span><span class="p">(</span><span class="s1">&#39;/action_ros_iot&#39;</span><span class="p">,</span>
                                          <span class="n">msgRosIotAction</span><span class="p">)</span>

        <span class="c1"># Dictionary to Store all the goal handels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_goal_handles</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Store the MQTT Topic on which to Publish in a variable</span>
        <span class="n">param_config_iot</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;config_pyiot&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config_mqtt_pub_topic</span> <span class="o">=</span> <span class="n">param_config_iot</span><span class="p">[</span><span class="s1">&#39;mqtt&#39;</span><span class="p">][</span><span class="s1">&#39;topic_pub&#39;</span><span class="p">]</span>

        <span class="c1"># Wait for Action Server that will use the action - &#39;/action_iot_ros&#39; to start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ac</span><span class="o">.</span><span class="n">wait_for_server</span><span class="p">()</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s2">&quot;Action server up, we can send goals.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="RosIotBridgeActionClient.on_transition"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_1_pick.html#node_ur5_1_pick.RosIotBridgeActionClient.on_transition">[docs]</a>    <span class="k">def</span> <span class="nf">on_transition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">goal_handle</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function will be called when there is change of state in the Action Client State</span>
<span class="sd">        Machine</span>

<span class="sd">        :param goal_handle: unique id of goal</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># from on_goal() to on_transition(). goal_handle generated by send_goal() is used here.</span>

        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_goal_handles</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_goal_handles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">goal_handle</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">break</span>

        <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s2">&quot;Transition Callback. Client Goal Handle #: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s2">&quot;Comm. State: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">goal_handle</span><span class="o">.</span><span class="n">get_comm_state</span><span class="p">()))</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s2">&quot;Goal Status: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">goal_handle</span><span class="o">.</span><span class="n">get_goal_status</span><span class="p">()))</span>

        <span class="c1"># Comm State - Monitors the State Machine of the Client which is different from Server&#39;s</span>
        <span class="c1"># Comm State = 2 -&gt; Active</span>
        <span class="c1"># Comm State = 3 -&gt; Wating for Result</span>
        <span class="c1"># Comm State = 7 -&gt; Done</span>

        <span class="c1"># if (Comm State == ACTIVE)</span>
        <span class="k">if</span> <span class="n">goal_handle</span><span class="o">.</span><span class="n">get_comm_state</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: Goal just went active.&quot;</span><span class="p">)</span>

        <span class="c1"># if (Comm State == DONE)</span>
        <span class="k">if</span> <span class="n">goal_handle</span><span class="o">.</span><span class="n">get_comm_state</span><span class="p">()</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: Goal is DONE&quot;</span><span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="n">goal_handle</span><span class="o">.</span><span class="n">get_terminal_state</span><span class="p">())</span>

            <span class="c1"># get_result() gets the result produced by the Action Server</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">goal_handle</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">flag_success</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">flag_success</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s2">&quot;Goal successfully completed. Client Goal Handle #: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s2">&quot;Goal failed. Client Goal Handle #: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span></div>

<div class="viewcode-block" id="RosIotBridgeActionClient.send_goal"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_1_pick.html#node_ur5_1_pick.RosIotBridgeActionClient.send_goal">[docs]</a>    <span class="k">def</span> <span class="nf">send_goal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_protocol</span><span class="p">,</span> <span class="n">arg_mode</span><span class="p">,</span> <span class="n">arg_topic</span><span class="p">,</span> <span class="n">arg_message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function is used to send Goals to Action Server</span>

<span class="sd">        :param arg_protocol: IoT protocol to follow (HTTP, MQTT, etc.)</span>
<span class="sd">        :type arg_protocol: str</span>
<span class="sd">        :param arg_mode: Mode whether to publish or subscribe</span>
<span class="sd">        :type arg_mode: str</span>
<span class="sd">        :param arg_topic: Topic to subscribe or publish to</span>
<span class="sd">        :type arg_topic: str</span>
<span class="sd">        :param arg_message: Message to push or publish</span>
<span class="sd">        :type arg_message: str</span>
<span class="sd">        :return: goal handle</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create a Goal Message object</span>
        <span class="n">goal</span> <span class="o">=</span> <span class="n">msgRosIotGoal</span><span class="p">()</span>

        <span class="n">goal</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">arg_protocol</span>
        <span class="n">goal</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">arg_mode</span>
        <span class="n">goal</span><span class="o">.</span><span class="n">topic</span> <span class="o">=</span> <span class="n">arg_topic</span>
        <span class="n">goal</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">arg_message</span>

        <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s2">&quot;Send goal.&quot;</span><span class="p">)</span>

        <span class="c1"># self.on_transition - It is a function pointer to a function which will be called when</span>
        <span class="c1">#                       there is a change of state in the Action Client State Machine</span>
        <span class="n">goal_handle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ac</span><span class="o">.</span><span class="n">send_goal</span><span class="p">(</span><span class="n">goal</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">on_transition</span><span class="p">,</span>
                                         <span class="kc">None</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">goal_handle</span></div></div>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_1_pick.html#node_ur5_1_pick.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main node to control UR5_1 arm.</span>

<span class="sd">    This function is called to start the pick and place operation of UR5_1 arm.</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Initialize the node</span>
    <span class="n">rospy</span><span class="o">.</span><span class="n">init_node</span><span class="p">(</span><span class="s1">&#39;node_ur5_1_pick&#39;</span><span class="p">)</span>

    <span class="c1"># Wait for models to spawn in gazebo</span>
    <span class="k">while</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="k">continue</span>

    <span class="c1"># Action Client initialized</span>
    <span class="n">action_client</span> <span class="o">=</span> <span class="n">RosIotBridgeActionClient</span><span class="p">()</span>

    <span class="c1"># Initialize object of class colourPkg to process colours of the packages</span>
    <span class="n">camera</span> <span class="o">=</span> <span class="n">ShelfCamera</span><span class="p">()</span>
    <span class="n">rospy</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="c1"># Detect colours of all the packages</span>
    <span class="n">qr_decode</span><span class="o">.</span><span class="n">detect_colours</span><span class="p">()</span>
    <span class="n">rospy</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="c1"># Print colour of the packages on terminal</span>
    <span class="n">camera</span><span class="o">.</span><span class="n">print_colours</span><span class="p">()</span>

    <span class="n">orders_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">orders_time_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">rospy</span><span class="o">.</span><span class="n">Subscriber</span><span class="p">(</span><span class="s1">&#39;eyrc/vb/orders&#39;</span><span class="p">,</span> <span class="n">NewOrder</span><span class="p">,</span> <span class="n">new_order_callback</span><span class="p">,</span>
                     <span class="p">(</span><span class="n">orders_list</span><span class="p">,</span> <span class="n">orders_time_list</span><span class="p">))</span>

    <span class="c1"># Update spreadsheet with Packages available in Inventory</span>
    <span class="n">update_inventory</span><span class="p">(</span><span class="n">camera</span><span class="o">.</span><span class="n">get_pkg_colour_list</span><span class="p">(),</span> <span class="n">action_client</span><span class="p">)</span>
    <span class="n">rospy</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="c1"># Dictionary to store all the saved trajectories</span>
    <span class="n">saved_trajectories</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Load saved trajectories and store them in dictionary for future use</span>
    <span class="n">load_saved_trajectories</span><span class="p">(</span><span class="n">saved_trajectories</span><span class="p">)</span>

    <span class="c1"># Initialize object to control of class Ur5Moveit to control ur5_1</span>
    <span class="n">ur5_1</span> <span class="o">=</span> <span class="n">Ur5Moveit</span><span class="p">(</span><span class="s1">&#39;ur5_1&#39;</span><span class="p">)</span>

    <span class="c1"># Home joint angles (position over the conveyor belt)</span>
    <span class="n">ur5_1_home_joint_angles</span> <span class="o">=</span> <span class="p">[</span><span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
                               <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="o">-</span><span class="mi">109</span><span class="p">),</span>
                               <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="o">-</span><span class="mi">82</span><span class="p">),</span>
                               <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="o">-</span><span class="mi">79</span><span class="p">),</span>
                               <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">90</span><span class="p">),</span>
                               <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">)]</span>

    <span class="c1"># Store total number of packages dropped on the conveyor belt</span>
    <span class="n">total_pkg_dropped</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Initialize object to store data of the dispatched package</span>
    <span class="n">dispatched_pkg</span> <span class="o">=</span> <span class="n">DispatchedPkg</span><span class="p">()</span>

    <span class="c1"># Topic to publish the dispatched pkg</span>
    <span class="n">dispatched_pkg_pub</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span><span class="s1">&#39;eyrc/ur5_2_place/pkg&#39;</span><span class="p">,</span> <span class="n">DispatchedPackage</span><span class="p">,</span> <span class="n">queue_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="n">ur5_1</span><span class="o">.</span><span class="n">set_joint_angles</span><span class="p">(</span><span class="n">ur5_1_home_joint_angles</span><span class="p">)</span>

    <span class="c1"># Start the conveyor belt at 100% speed</span>
    <span class="n">start_conveyor_belt</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

    <span class="c1"># Main loop</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># Break the loop once all 9 packages are dropped on the conveyor belt</span>
        <span class="k">if</span> <span class="n">total_pkg_dropped</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="k">if</span> <span class="n">orders_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">total_pkg_dropped</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">orders_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;Order ID&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1002&quot;</span><span class="p">:</span>
                        <span class="k">break</span>

            <span class="n">current_order</span> <span class="o">=</span> <span class="n">orders_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">orders_list</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">row</span><span class="p">,</span> <span class="n">column</span> <span class="o">=</span> <span class="n">find_correct_pkg_on_shelf</span><span class="p">(</span><span class="n">camera</span><span class="p">,</span> <span class="n">current_order</span><span class="p">)</span>

            <span class="c1"># If correct package is found</span>
            <span class="k">if</span> <span class="n">row</span> <span class="ow">or</span> <span class="n">column</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                <span class="c1"># Play the saved to trajectory to pick the package</span>
                <span class="n">trajectory_name</span> <span class="o">=</span> <span class="s1">&#39;home_to_pkgn&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">column</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.yaml&#39;</span>
                <span class="n">ur5_1</span><span class="o">.</span><span class="n">hard_play_saved_trajectory</span><span class="p">(</span><span class="n">saved_trajectories</span><span class="p">[</span><span class="n">trajectory_name</span><span class="p">],</span> <span class="mi">5</span><span class="p">)</span>

                <span class="c1"># Attach the package EE of ur5_1</span>
                <span class="n">ur5_1</span><span class="o">.</span><span class="n">attach_box_in_gazebo</span><span class="p">()</span>

                <span class="c1"># Play the trajectory to drop the package on conveyor belt</span>
                <span class="n">trajectory_name</span> <span class="o">=</span> <span class="s1">&#39;pkgn&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">column</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_to_home.yaml&#39;</span>
                <span class="n">ur5_1</span><span class="o">.</span><span class="n">hard_play_saved_trajectory</span><span class="p">(</span><span class="n">saved_trajectories</span><span class="p">[</span><span class="n">trajectory_name</span><span class="p">],</span> <span class="mi">5</span><span class="p">)</span>

                <span class="c1"># Deactivate the vacuum gripper to drop the package</span>
                <span class="n">ur5_1</span><span class="o">.</span><span class="n">detach_box_in_gazebo</span><span class="p">()</span>

                <span class="c1"># Store data of dispatched package</span>
                <span class="n">dispatched_pkg</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">column</span><span class="p">))</span>
                <span class="n">dispatched_pkg</span><span class="o">.</span><span class="n">set_colour</span><span class="p">(</span><span class="n">current_order</span><span class="p">[</span><span class="s2">&quot;Colour&quot;</span><span class="p">])</span>

                <span class="c1"># Publish the data of the package that has been just dropped</span>
                <span class="n">dispatched_pkg_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">dispatched_pkg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                           <span class="n">dispatched_pkg</span><span class="o">.</span><span class="n">colour</span><span class="p">,</span>
                                           <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">current_order</span><span class="p">))</span>

                <span class="n">update_orders_dispatched_sheet</span><span class="p">(</span><span class="n">current_order</span><span class="p">,</span> <span class="n">action_client</span><span class="p">)</span>

                <span class="n">total_pkg_dropped</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># print(&quot;Start time: &quot;, start_time)</span>
    <span class="c1"># print(&quot;Time list: &quot;, orders_time_list)</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">rospy</span><span class="o">.</span><span class="n">is_shutdown</span><span class="p">():</span>
        <span class="k">continue</span></div>


<div class="viewcode-block" id="update_inventory"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_1_pick.html#node_ur5_1_pick.update_inventory">[docs]</a><span class="k">def</span> <span class="nf">update_inventory</span><span class="p">(</span><span class="n">pkg_colour_list</span><span class="p">,</span> <span class="n">action_client</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update inventory spreadsheet</span>

<span class="sd">    :param pkg_colour_list: List of colour of all the packages present on the shelf</span>
<span class="sd">    :type pkg_colour_list: list</span>
<span class="sd">    :param action_client: action client to send goals to push data on spreadsheet</span>
<span class="sd">    :type action_client: Object of class RosIotBridgeActionClient</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">team_id</span> <span class="o">=</span> <span class="s2">&quot;VB#0574&quot;</span>
    <span class="n">unique_id</span> <span class="o">=</span> <span class="s2">&quot;isPicuTP&quot;</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">pkg_colour_list</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">column</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;red&#39;</span><span class="p">:</span>
                <span class="n">sku</span> <span class="o">=</span> <span class="s2">&quot;R&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">column</span><span class="p">)</span><span class="o">+</span><span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%m&quot;</span><span class="p">)</span><span class="o">+</span><span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%y&quot;</span><span class="p">)</span>
                <span class="n">item</span> <span class="o">=</span> <span class="s2">&quot;Medicine&quot;</span>
                <span class="n">priority</span> <span class="o">=</span> <span class="s2">&quot;HP&quot;</span>
                <span class="n">cost</span> <span class="o">=</span> <span class="mi">450</span>
            <span class="k">elif</span> <span class="n">pkg_colour_list</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">column</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;yellow&#39;</span><span class="p">:</span>
                <span class="n">sku</span> <span class="o">=</span> <span class="s2">&quot;Y&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">column</span><span class="p">)</span> <span class="o">+</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%m&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%y&quot;</span><span class="p">)</span>
                <span class="n">item</span> <span class="o">=</span> <span class="s2">&quot;Food&quot;</span>
                <span class="n">priority</span> <span class="o">=</span> <span class="s2">&quot;MP&quot;</span>
                <span class="n">cost</span> <span class="o">=</span> <span class="mi">250</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sku</span> <span class="o">=</span> <span class="s2">&quot;G&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">column</span><span class="p">)</span> <span class="o">+</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%m&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%y&quot;</span><span class="p">)</span>
                <span class="n">item</span> <span class="o">=</span> <span class="s2">&quot;Clothes&quot;</span>
                <span class="n">priority</span> <span class="o">=</span> <span class="s2">&quot;LP&quot;</span>
                <span class="n">cost</span> <span class="o">=</span> <span class="mi">150</span>

            <span class="n">storage_no</span> <span class="o">=</span> <span class="s2">&quot;R&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; C&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
            <span class="n">quantity</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;Inventory&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;Team Id&quot;</span><span class="p">:</span> <span class="n">team_id</span><span class="p">,</span>
                          <span class="s2">&quot;Unique Id&quot;</span><span class="p">:</span> <span class="n">unique_id</span><span class="p">,</span>
                          <span class="s2">&quot;SKU&quot;</span><span class="p">:</span> <span class="n">sku</span><span class="p">,</span>
                          <span class="s2">&quot;Item&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">,</span>
                          <span class="s2">&quot;Priority&quot;</span><span class="p">:</span> <span class="n">priority</span><span class="p">,</span>
                          <span class="s2">&quot;Storage Number&quot;</span><span class="p">:</span> <span class="n">storage_no</span><span class="p">,</span>
                          <span class="s2">&quot;Cost&quot;</span><span class="p">:</span> <span class="n">cost</span><span class="p">,</span>
                          <span class="s2">&quot;Quantity&quot;</span><span class="p">:</span> <span class="n">quantity</span><span class="p">}</span>

            <span class="n">action_client</span><span class="o">.</span><span class="n">send_goal</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="s2">&quot;NA&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">parameters</span><span class="p">))</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span></div>


<div class="viewcode-block" id="update_orders_dispatched_sheet"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_1_pick.html#node_ur5_1_pick.update_orders_dispatched_sheet">[docs]</a><span class="k">def</span> <span class="nf">update_orders_dispatched_sheet</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">action_client</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update dispatched orders spreadsheet</span>

<span class="sd">    :param order: Information of the order dispatched</span>
<span class="sd">    :type order: dict</span>
<span class="sd">    :param action_client: action client to send goal to push data on spreadsheet</span>
<span class="sd">    :type action_client: Object of class RosIotBridgeActionClient</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>
    <span class="n">str_time</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>

    <span class="n">team_id</span> <span class="o">=</span> <span class="s2">&quot;VB#0574&quot;</span>
    <span class="n">unique_id</span> <span class="o">=</span> <span class="s2">&quot;isPicuTP&quot;</span>

    <span class="k">if</span> <span class="n">order</span><span class="p">[</span><span class="s2">&quot;Item&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Medicine&quot;</span><span class="p">:</span>
        <span class="n">priority</span> <span class="o">=</span> <span class="s2">&quot;HP&quot;</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="mi">450</span>
    <span class="k">elif</span> <span class="n">order</span><span class="p">[</span><span class="s2">&quot;Item&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Food&quot;</span><span class="p">:</span>
        <span class="n">priority</span> <span class="o">=</span> <span class="s2">&quot;MP&quot;</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="mi">250</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">priority</span> <span class="o">=</span> <span class="s2">&quot;LP&quot;</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="mi">150</span>

    <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;OrdersDispatched&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;Team Id&quot;</span><span class="p">:</span> <span class="n">team_id</span><span class="p">,</span>
                  <span class="s2">&quot;Unique Id&quot;</span><span class="p">:</span> <span class="n">unique_id</span><span class="p">,</span>
                  <span class="s2">&quot;Order ID&quot;</span><span class="p">:</span> <span class="n">order</span><span class="p">[</span><span class="s2">&quot;Order ID&quot;</span><span class="p">],</span>
                  <span class="s2">&quot;City&quot;</span><span class="p">:</span> <span class="n">order</span><span class="p">[</span><span class="s2">&quot;City&quot;</span><span class="p">],</span>
                  <span class="s2">&quot;Item&quot;</span><span class="p">:</span> <span class="n">order</span><span class="p">[</span><span class="s2">&quot;Item&quot;</span><span class="p">],</span>
                  <span class="s2">&quot;Priority&quot;</span><span class="p">:</span> <span class="n">priority</span><span class="p">,</span>
                  <span class="s2">&quot;Dispatch Quantity&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                  <span class="s2">&quot;Cost&quot;</span><span class="p">:</span> <span class="n">cost</span><span class="p">,</span>
                  <span class="s2">&quot;Dispatch Status&quot;</span><span class="p">:</span> <span class="s2">&quot;Yes&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;Dispatch Date and Time&quot;</span><span class="p">:</span> <span class="n">str_time</span><span class="p">}</span>

    <span class="n">action_client</span><span class="o">.</span><span class="n">send_goal</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="s2">&quot;NA&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">parameters</span><span class="p">))</span></div>


<div class="viewcode-block" id="new_order_callback"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_1_pick.html#node_ur5_1_pick.new_order_callback">[docs]</a><span class="k">def</span> <span class="nf">new_order_callback</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Callback function called whenever a new order is placed</span>

<span class="sd">    :param msg: Order details</span>
<span class="sd">    :type msg: json object</span>
<span class="sd">    :param args: List of the current active orders</span>
<span class="sd">    :type args: list</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">orders_list</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">orders_time_list</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">order</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">order</span><span class="p">[</span><span class="s2">&quot;Priority&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;HP&quot;</span><span class="p">:</span>
        <span class="n">order</span><span class="p">[</span><span class="s2">&quot;Colour&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span>
    <span class="k">elif</span> <span class="n">order</span><span class="p">[</span><span class="s2">&quot;Priority&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;MP&quot;</span><span class="p">:</span>
        <span class="n">order</span><span class="p">[</span><span class="s2">&quot;Colour&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;yellow&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">order</span><span class="p">[</span><span class="s2">&quot;Colour&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;green&quot;</span>

    <span class="n">orders_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>

    <span class="n">sorted_orders_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">orders_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="p">[</span><span class="s2">&quot;Cost&quot;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">orders_list</span><span class="p">[:]</span>
    <span class="n">orders_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">sorted_orders_list</span><span class="p">)</span>

    <span class="n">orders_time_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">order</span><span class="p">[</span><span class="s2">&quot;Priority&quot;</span><span class="p">],</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">()])</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;######### UPDATED ORDERS LIST ##########&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">orders_list</span><span class="p">)</span></div>


<div class="viewcode-block" id="load_saved_trajectories"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_1_pick.html#node_ur5_1_pick.load_saved_trajectories">[docs]</a><span class="k">def</span> <span class="nf">load_saved_trajectories</span><span class="p">(</span><span class="n">saved_trajectories</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load all the saved trajectories and store them in a dictionary</span>

<span class="sd">    :param saved_trajectories: Dictionary to store the loaded trajectories</span>
<span class="sd">    :type saved_trajectories: dict</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ros_pkg</span> <span class="o">=</span> <span class="n">rospkg</span><span class="o">.</span><span class="n">RosPack</span><span class="p">()</span>
    <span class="n">arg_file_path</span> <span class="o">=</span> <span class="n">ros_pkg</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s1">&#39;pkg_task5&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/config/saved_trajectories/&#39;</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">arg_file_name</span> <span class="o">=</span> <span class="s1">&#39;home_to_pkgn&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">column</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.yaml&#39;</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">arg_file_path</span> <span class="o">+</span> <span class="n">arg_file_name</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_open</span><span class="p">:</span>
                <span class="n">saved_trajectories</span><span class="p">[</span><span class="n">arg_file_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_open</span><span class="p">)</span>

            <span class="n">arg_file_name</span> <span class="o">=</span> <span class="s1">&#39;pkgn&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">column</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_to_home.yaml&#39;</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">arg_file_path</span> <span class="o">+</span> <span class="n">arg_file_name</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_open</span><span class="p">:</span>
                <span class="n">saved_trajectories</span><span class="p">[</span><span class="n">arg_file_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_open</span><span class="p">)</span></div>


<div class="viewcode-block" id="start_conveyor_belt"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_1_pick.html#node_ur5_1_pick.start_conveyor_belt">[docs]</a><span class="k">def</span> <span class="nf">start_conveyor_belt</span><span class="p">(</span><span class="n">power</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to start the conveyor belt at a certain power</span>

<span class="sd">    :param power: power of the belt to be set</span>
<span class="sd">    :type power: int</span>
<span class="sd">    :return: success flag</span>
<span class="sd">    :rtype: bool</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rospy</span><span class="o">.</span><span class="n">wait_for_service</span><span class="p">(</span><span class="s1">&#39;/eyrc/vb/conveyor/set_power&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">power_service</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceProxy</span><span class="p">(</span><span class="s1">&#39;/eyrc/vb/conveyor/set_power&#39;</span><span class="p">,</span> <span class="n">conveyorBeltPowerMsg</span><span class="p">)</span>
        <span class="n">resp1</span> <span class="o">=</span> <span class="n">power_service</span><span class="p">(</span><span class="n">power</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resp1</span><span class="o">.</span><span class="n">result</span>

    <span class="k">except</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceException</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Service call failed: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">exception</span><span class="p">)</span></div>


<div class="viewcode-block" id="stop_conveyor_belt"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_1_pick.html#node_ur5_1_pick.stop_conveyor_belt">[docs]</a><span class="k">def</span> <span class="nf">stop_conveyor_belt</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to stop the conveyor belt</span>

<span class="sd">    :return: Success flag</span>
<span class="sd">    :rtype: bool</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rospy</span><span class="o">.</span><span class="n">wait_for_service</span><span class="p">(</span><span class="s1">&#39;/eyrc/vb/conveyor/set_power&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">power</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceProxy</span><span class="p">(</span><span class="s1">&#39;/eyrc/vb/conveyor/set_power&#39;</span><span class="p">,</span> <span class="n">conveyorBeltPowerMsg</span><span class="p">)</span>
        <span class="n">resp1</span> <span class="o">=</span> <span class="n">power</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resp1</span><span class="o">.</span><span class="n">result</span>

    <span class="k">except</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceException</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Service call failed: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">exception</span><span class="p">)</span></div>


<div class="viewcode-block" id="find_correct_pkg_on_shelf"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_1_pick.html#node_ur5_1_pick.find_correct_pkg_on_shelf">[docs]</a><span class="k">def</span> <span class="nf">find_correct_pkg_on_shelf</span><span class="p">(</span><span class="n">camera</span><span class="p">,</span> <span class="n">current_order</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to find the correct package to be picked up from the shelf</span>

<span class="sd">    :param camera: object storing information packages present on the shelf</span>
<span class="sd">    :type camera: Object of class ShelfCamera</span>
<span class="sd">    :param current_order: Details of order to find on the shelf</span>
<span class="sd">    :type current_order: dict</span>
<span class="sd">    :return: row and column of the required package</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Search order of packages while selecting the package to pick up</span>
    <span class="n">pkg_search_order</span> <span class="o">=</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">30</span><span class="p">]</span>

    <span class="n">row</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">column</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">pkg_no</span> <span class="ow">in</span> <span class="n">pkg_search_order</span><span class="p">:</span>
        <span class="n">row</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pkg_no</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">column</span> <span class="o">=</span> <span class="n">pkg_no</span> <span class="o">%</span> <span class="mi">10</span>

        <span class="k">if</span> <span class="n">camera</span><span class="o">.</span><span class="n">get_pkg_colour</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span> <span class="o">==</span> <span class="n">current_order</span><span class="p">[</span><span class="s1">&#39;Colour&#39;</span><span class="p">]:</span>
            <span class="c1"># Update the inventory and mark the package as NA</span>
            <span class="n">camera</span><span class="o">.</span><span class="n">pkg_colour_list</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;NA&#39;</span>
            <span class="k">break</span>

    <span class="k">return</span> <span class="n">row</span><span class="p">,</span> <span class="n">column</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Rahul, Team Leader VB#0574.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>