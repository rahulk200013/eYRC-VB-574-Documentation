

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>node_ur5_2_place &mdash; eYRC VB#0574 Task 5 1.0 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> eYRC VB#0574 Task 5
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../rst/software_specs.html">1. Software Specifications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rst/installations.html">2. Insatllations</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../rst/installations/rosmelodic.html">2.1. ROS Installation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../rst/installations/rosmelodic.html#installation-instruction">2.1.1. Installation Instruction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rst/installations/rosmelodic.html#ros-melodic-installation">2.1.2. ROS Melodic Installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rst/installations/rosmelodic.html#installation-steps">2.1.3. Installation Steps</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rst/installations/rosmelodic.html#configuration-steps">2.1.4. Configuration Steps</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rst/installations/rosmelodic.html#additional-packages-to-install">2.1.5. Additional packages to install</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rst/installations/rosmelodic.html#references">2.1.6. References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../rst/installations/moveit.html">2.2. MoveIt! for ROS Melodic</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rst/installations/vbsimpkg.html">2.3. Vargi Bots Simulation Packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rst/installations/pahomqtt.html">2.4. Paho MQTT Library</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../rst/installations/pahomqtt.html#installation-instruction">2.4.1. Installation Instruction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rst/installations/pahomqtt.html#example-mqtt-pub-sub">2.4.2. Example MQTT Pub-Sub</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../rst/installations/pahomqtt.html#sub-py">2.4.2.1. sub.py</a></li>
<li class="toctree-l4"><a class="reference internal" href="../rst/installations/pahomqtt.html#pub-py">2.4.2.2. pub.py</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../rst/installations/pahomqtt.html#references">2.4.3. References</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../rst/introduction.html">3. Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../rst/introduction.html#overview">3.1. Overview</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../rst/introduction.html#strategies-used-to-save-time">3.1.1. Strategies used to save time</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../rst/introduction.html#video-demonstration">3.2. Video Demonstration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../rst/implementation.html">4. Implementation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../rst/implementation.html#setting-up-gazebo-and-planning-scene">4.1. Setting up Gazebo and Planning Scene</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rst/implementation.html#saving-trajectories">4.2. Saving Trajectories</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../rst/implementation.html#determining-execution-time">4.2.1. Determining Execution Time</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rst/implementation.html#automate-trajectory-saving">4.2.2. Automate Trajectory Saving</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../rst/implementation.html#qr-detection">4.3. QR Detection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rst/implementation.html#ros-iot-bridge-setup">4.4. Ros-IoT Bridge Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rst/implementation.html#order-handling">4.5. Order Handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rst/implementation.html#picking-up-packages-from-shelf">4.6. Picking Up Packages From Shelf</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../rst/implementation.html#there-are-no-orders-to-process-for-now">4.6.1. There are no orders to process for now</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rst/implementation.html#there-are-orders-to-process">4.6.2. There are orders to process</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../rst/implementation.html#placing-packages-in-the-bin">4.7. Placing Packages in the Bin</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../rst/implementation.html#deciding-position-to-pickup-the-package">4.7.1. Deciding position to pickup the package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rst/implementation.html#keeping-the-conveyor-belt-running">4.7.2. Keeping the Conveyor Belt running</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../rst/implementation.html#when-ur5-2-arm-is-free">4.7.2.1. When UR5#2 arm is free</a></li>
<li class="toctree-l4"><a class="reference internal" href="../rst/implementation.html#when-ur5-2-arm-is-busy">4.7.2.2. When UR5#2 arm is busy</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../rst/implementation.html#dashboard">4.8. Dashboard</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../rst/implementation.html#map">4.8.1. Map</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rst/implementation.html#table">4.8.2. Table</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rst/implementation.html#bar-graph">4.8.3. Bar Graph</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../rst/implementation.html#rqt-graph">4.9. RQT Graph</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../rst/api_documentation.html">5. API Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../rst/api_documentation.html#package-task-5">5.1. Package Task 5</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../rst/pkg_task5/python_scripts.html">5.1.1. Python Scripts</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../rst/pkg_task5/scripts/node_ur5_1_pick.html">5.1.1.1. node_ur5_1_pick</a></li>
<li class="toctree-l4"><a class="reference internal" href="../rst/pkg_task5/scripts/node_ur5_2_place.html">5.1.1.2. node_ur5_2_place</a></li>
<li class="toctree-l4"><a class="reference internal" href="../rst/pkg_task5/scripts/incoming_order_handler.html">5.1.1.3. incoming_order_handler</a></li>
<li class="toctree-l4"><a class="reference internal" href="../rst/pkg_task5/scripts/qr/qr_decode.html">5.1.1.4. qr/qr_decode</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../rst/pkg_task5/msg_files.html">5.1.2. Message Files</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../rst/pkg_task5/msg/Camera1Image.html">5.1.2.1. Camera1Image.msg</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../rst/pkg_task5/msg/Camera1Image.html#description">5.1.2.1.1. Description</a></li>
<li class="toctree-l5"><a class="reference internal" href="../rst/pkg_task5/msg/Camera1Image.html#parameters">5.1.2.1.2. Parameters</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../rst/pkg_task5/msg/DispatchedPackage.html">5.1.2.2. DispatchedPackage.msg</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../rst/pkg_task5/msg/DispatchedPackage.html#description">5.1.2.2.1. Description</a></li>
<li class="toctree-l5"><a class="reference internal" href="../rst/pkg_task5/msg/DispatchedPackage.html#parameters">5.1.2.2.2. Parameters</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../rst/pkg_task5/msg/NewOrder.html">5.1.2.3. NewOrder.msg</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../rst/pkg_task5/msg/NewOrder.html#description">5.1.2.3.1. Description</a></li>
<li class="toctree-l5"><a class="reference internal" href="../rst/pkg_task5/msg/NewOrder.html#parameters">5.1.2.3.2. Parameters</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../rst/pkg_task5/launch_files.html">5.1.3. Launch Files</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../rst/pkg_task5/launch/task5_solution.html">5.1.3.1. task5_solution.launch</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../rst/pkg_task5/launch/task5_solution.html#description">5.1.3.1.1. Description</a></li>
<li class="toctree-l5"><a class="reference internal" href="../rst/pkg_task5/launch/task5_solution.html#job">5.1.3.1.2. Job</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../rst/pkg_task5/YAML_files.html">5.1.4. YAML Files</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../rst/pkg_task5/config/saved_trajectories/home_to_pkgnxx.html">5.1.4.1. home_to_pkgn<em>xx</em>.yaml</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../rst/pkg_task5/config/saved_trajectories/home_to_pkgnxx.html#description">5.1.4.1.1. Description</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../rst/pkg_task5/config/saved_trajectories/pkgnxx_to_home.html">5.1.4.2. pkgn<em>xx</em>_to_home.yaml</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../rst/pkg_task5/config/saved_trajectories/pkgnxx_to_home.html#description">5.1.4.2.1. Description</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../rst/pkg_task5/config/saved_trajectories/home_to_waiting_pose_1.html">5.1.4.3. home_to_waiting_pose_1.yaml</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../rst/pkg_task5/config/saved_trajectories/home_to_waiting_pose_1.html#description">5.1.4.3.1. Description</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../rst/pkg_task5/config/saved_trajectories/waiting_pose_1_to_pkgnxx.html">5.1.4.4. waiting_pose_1_to_pkgn<em>xx</em>.yaml</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../rst/pkg_task5/config/saved_trajectories/waiting_pose_1_to_pkgnxx.html#description">5.1.4.4.1. Description</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../rst/pkg_task5/config/saved_trajectories/home_y_to_xxx_bin.html">5.1.4.5. home_y_to_xxx_bin.yaml</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../rst/pkg_task5/config/saved_trajectories/home_y_to_xxx_bin.html#description">5.1.4.5.1. Description</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../rst/pkg_task5/config/saved_trajectories/xxx_bin_to_home_y.html">5.1.4.6. xxx_bin_to_home_y.yaml</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../rst/pkg_task5/config/saved_trajectories/xxx_bin_to_home_y.html#description">5.1.4.6.1. Description</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../rst/api_documentation.html#package-ros-iot-bridge">5.2. Package Ros-IoT Bridge</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../rst/pkg_ros_iot_bridge/python_scripts.html">5.2.1. Python Scripts</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../rst/pkg_ros_iot_bridge/scripts/node_action_server_ros_iot_bridge.html">5.2.1.1. node_action_server_ros_iot_bridge</a></li>
<li class="toctree-l4"><a class="reference internal" href="../rst/pkg_ros_iot_bridge/scripts/pyiot/iot.html">5.2.1.2. pyiot/iot</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../rst/pkg_ros_iot_bridge/msg_files.html">5.2.2. Message Files</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../rst/pkg_ros_iot_bridge/msg/msgMqttSub.html">5.2.2.1. msgMqttSub.msg</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../rst/pkg_ros_iot_bridge/msg/msgMqttSub.html#description">5.2.2.1.1. Description</a><ul>
<li class="toctree-l6"><a class="reference internal" href="../rst/pkg_ros_iot_bridge/msg/msgMqttSub.html#parameters">5.2.2.1.1.1. Parameters</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../rst/pkg_ros_iot_bridge/action_files.html">5.2.3. Action Files</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../rst/pkg_ros_iot_bridge/action/msgRosIot.html">5.2.3.1. msgRosIot.action</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../rst/pkg_ros_iot_bridge/action/msgRosIot.html#description">5.2.3.1.1. Description</a></li>
<li class="toctree-l5"><a class="reference internal" href="../rst/pkg_ros_iot_bridge/action/msgRosIot.html#parameters">5.2.3.1.2. Parameters</a><ul>
<li class="toctree-l6"><a class="reference internal" href="../rst/pkg_ros_iot_bridge/action/msgRosIot.html#goal">5.2.3.1.2.1. Goal</a></li>
<li class="toctree-l6"><a class="reference internal" href="../rst/pkg_ros_iot_bridge/action/msgRosIot.html#feedback">5.2.3.1.2.2. Feedback</a></li>
<li class="toctree-l6"><a class="reference internal" href="../rst/pkg_ros_iot_bridge/action/msgRosIot.html#result">5.2.3.1.2.3. Result</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../rst/pkg_ros_iot_bridge/config_files.html">5.2.4. Config Files</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../rst/pkg_ros_iot_bridge/config/config_pyiot.html">5.2.4.1. config_pyiot.yaml</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../rst/pkg_ros_iot_bridge/config/config_pyiot.html#description">5.2.4.1.1. Description</a></li>
<li class="toctree-l5"><a class="reference internal" href="../rst/pkg_ros_iot_bridge/config/config_pyiot.html#parameters">5.2.4.1.2. Parameters</a><ul>
<li class="toctree-l6"><a class="reference internal" href="../rst/pkg_ros_iot_bridge/config/config_pyiot.html#mqtt">5.2.4.1.2.1. MQTT</a></li>
<li class="toctree-l6"><a class="reference internal" href="../rst/pkg_ros_iot_bridge/config/config_pyiot.html#google-apps">5.2.4.1.2.2. Google Apps</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">eYRC VB#0574 Task 5</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>node_ur5_2_place</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for node_ur5_2_place</h1><div class="highlight"><pre>
<span></span><span class="ch">#! /usr/bin/env python</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">ROS Node for UR5_2 arm to pick packages from conveyor belt and place them in respective bins</span>
<span class="sd">according to their colour.</span>

<span class="sd">When the order is dispatched from UR5_1 arm side, the details of the order are received by this</span>
<span class="sd">node. This information is used to determine the bin in which the package needs to be dropped and</span>
<span class="sd">to update the &quot;ShippedOrders&quot; sheet using Action Client. The position from where the arm will pick</span>
<span class="sd">the package from conveyor belt is determined on the basis of whether the arm will be able to pickup</span>
<span class="sd">the package from home position #1 or not. If not it will pick the package from home position #2.</span>
<span class="sd">This is done to make sure that the conveyor belt is kept on for most of the time and packages are</span>
<span class="sd">picked as soon as possible from the conveyor belt.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="kn">import</span> <span class="nn">rospy</span>
<span class="kn">import</span> <span class="nn">moveit_commander</span>
<span class="kn">import</span> <span class="nn">moveit_msgs.msg</span>
<span class="kn">import</span> <span class="nn">actionlib</span>
<span class="kn">import</span> <span class="nn">rospkg</span>
<span class="kn">import</span> <span class="nn">yaml</span>


<span class="kn">from</span> <span class="nn">pkg_vb_sim.srv</span> <span class="kn">import</span> <span class="n">conveyorBeltPowerMsg</span>
<span class="kn">from</span> <span class="nn">pkg_vb_sim.srv</span> <span class="kn">import</span> <span class="n">vacuumGripper</span>

<span class="kn">from</span> <span class="nn">pkg_ros_iot_bridge.msg</span> <span class="kn">import</span> <span class="n">msgRosIotAction</span>
<span class="kn">from</span> <span class="nn">pkg_ros_iot_bridge.msg</span> <span class="kn">import</span> <span class="n">msgRosIotGoal</span>

<span class="kn">from</span> <span class="nn">pkg_task5.msg</span> <span class="kn">import</span> <span class="n">DispatchedPackage</span>

<span class="kn">from</span> <span class="nn">hrwros_gazebo.msg</span> <span class="kn">import</span> <span class="n">LogicalCameraImage</span>


<div class="viewcode-block" id="Ur5Moveit"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_2_place.html#node_ur5_2_place.Ur5Moveit">[docs]</a><span class="k">class</span> <span class="nc">Ur5Moveit</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize necessary objects to operate a UR5 arm</span>

<span class="sd">    Initialize trajectory publisher, execute client, planning scene interface,</span>
<span class="sd">    move group commander, vacuum gripper service and other necessary things</span>
<span class="sd">    for proper interface of Ur5 arm with Gazebo, MoveIt! and RViz</span>

<span class="sd">    :param arg_robot_name: Name of Ur5 arm to control</span>
<span class="sd">    :type arg_robot_name: str</span>

<span class="sd">    :Example:</span>

<span class="sd">    ur5_2 = Ur5Moveit(&#39;ur5_2&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># pylint: disable=too-many-instance-attributes</span>

    <span class="c1"># Constructor</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_robot_name</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_robot_ns</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">arg_robot_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_planning_group</span> <span class="o">=</span> <span class="s2">&quot;manipulator&quot;</span>

        <span class="n">moveit_commander</span><span class="o">.</span><span class="n">roscpp_initialize</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_robot</span> <span class="o">=</span> <span class="n">moveit_commander</span><span class="o">.</span><span class="n">RobotCommander</span><span class="p">(</span><span class="n">robot_description</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_robot_ns</span> <span class="o">+</span>
                                                      <span class="s2">&quot;/robot_description&quot;</span><span class="p">,</span>
                                                      <span class="n">ns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_robot_ns</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scene</span> <span class="o">=</span> <span class="n">moveit_commander</span><span class="o">.</span><span class="n">PlanningSceneInterface</span><span class="p">(</span><span class="n">ns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_robot_ns</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_group</span> <span class="o">=</span> <span class="n">moveit_commander</span><span class="o">.</span><span class="n">MoveGroupCommander</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_planning_group</span><span class="p">,</span>
                                                          <span class="n">robot_description</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_robot_ns</span> <span class="o">+</span>
                                                          <span class="s2">&quot;/robot_description&quot;</span><span class="p">,</span>
                                                          <span class="n">ns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_robot_ns</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_display_trajectory_publisher</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_robot_ns</span> <span class="o">+</span>
                                                             <span class="s1">&#39;/move_group/display_planned_path&#39;</span><span class="p">,</span>
                                                             <span class="n">moveit_msgs</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">DisplayTrajectory</span><span class="p">,</span>
                                                             <span class="n">queue_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exectute_trajectory_client</span> <span class="o">=</span> <span class="n">actionlib</span><span class="o">.</span><span class="n">SimpleActionClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_robot_ns</span> <span class="o">+</span>
                                                                        <span class="s1">&#39;/execute_trajectory&#39;</span><span class="p">,</span>
                                                                        <span class="n">moveit_msgs</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span>
                                                                        <span class="n">ExecuteTrajectoryAction</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exectute_trajectory_client</span><span class="o">.</span><span class="n">wait_for_server</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_planning_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="o">.</span><span class="n">get_planning_frame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eef_link</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="o">.</span><span class="n">get_end_effector_link</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_group_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_robot</span><span class="o">.</span><span class="n">get_group_names</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_box_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vacuum_gripper_service</span> <span class="o">=</span> <span class="s1">&#39;/eyrc/vb/ur5/activate_vacuum_gripper/&#39;</span> <span class="o">+</span> <span class="n">arg_robot_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_computed_plan</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">incoming_pkg_list</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pkg_not_pickable</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pkg_detected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_bin</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_bin</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">home</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pkg_start_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pkg_final_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_lapsed_since_dispatch</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">home_position_updated</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">orders_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">ros_pkg</span> <span class="o">=</span> <span class="n">rospkg</span><span class="o">.</span><span class="n">RosPack</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pkg_path</span> <span class="o">=</span> <span class="n">ros_pkg</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s1">&#39;pkg_task5&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pkg_path</span> <span class="o">+</span> <span class="s1">&#39;/config/saved_trajectories/&#39;</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s2">&quot;Package Path: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file_path</span><span class="p">))</span>

        <span class="c1"># Current State of the Robot is needed to add box to planning scene</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_curr_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_robot</span><span class="o">.</span><span class="n">get_current_state</span><span class="p">()</span>

        <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[94m&#39;</span> <span class="o">+</span> <span class="s2">&quot;Planning Group: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_planning_frame</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[94m&#39;</span> <span class="o">+</span> <span class="s2">&quot;End Effector Link: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_eef_link</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[94m&#39;</span> <span class="o">+</span> <span class="s2">&quot;Group Names: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_group_names</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span>

        <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[94m&#39;</span> <span class="o">+</span> <span class="s2">&quot; &gt;&gt;&gt; Ur5Moveit init done.&quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Ur5Moveit.get_file_path"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_2_place.html#node_ur5_2_place.Ur5Moveit.get_file_path">[docs]</a>    <span class="k">def</span> <span class="nf">get_file_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return path to saved trajectories</span>

<span class="sd">        :return: Path of folder where trajectories are saved</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_path</span></div>

<div class="viewcode-block" id="Ur5Moveit.go_to_pose"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_2_place.html#node_ur5_2_place.Ur5Moveit.go_to_pose">[docs]</a>    <span class="k">def</span> <span class="nf">go_to_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_pose</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make the vacuum gripper go to a certain position in space</span>

<span class="sd">        :param arg_pose: goal pose of the vacuum gripper</span>
<span class="sd">        :type arg_pose: geometry_msgs.msg.Pose()</span>
<span class="sd">        :return: Success flag</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="o">.</span><span class="n">set_pose_target</span><span class="p">(</span><span class="n">arg_pose</span><span class="p">)</span>
        <span class="n">flag_plan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="o">.</span><span class="n">go</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># wait=False for Async Move</span>

        <span class="k">return</span> <span class="n">flag_plan</span></div>

<div class="viewcode-block" id="Ur5Moveit.hard_go_to_pose"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_2_place.html#node_ur5_2_place.Ur5Moveit.hard_go_to_pose">[docs]</a>    <span class="k">def</span> <span class="nf">hard_go_to_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_pose</span><span class="p">,</span> <span class="n">arg_max_attempts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Try going to a pose again and until success or max attempts exhausted</span>

<span class="sd">        :param arg_pose: goal pose of the vacuum gripper</span>
<span class="sd">        :type arg_pose: geometry_msgs.msg.Pose()</span>
<span class="sd">        :param arg_max_attempts: maximum number of attempts to try</span>
<span class="sd">        :type arg_max_attempts: int</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">number_attempts</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">flag_success</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">while</span> <span class="n">number_attempts</span> <span class="o">&lt;=</span> <span class="n">arg_max_attempts</span> <span class="ow">and</span> <span class="n">flag_success</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">number_attempts</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">flag_success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">go_to_pose</span><span class="p">(</span><span class="n">arg_pose</span><span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="s2">&quot;attempts: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number_attempts</span><span class="p">))</span></div>

<div class="viewcode-block" id="Ur5Moveit.set_joint_angles"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_2_place.html#node_ur5_2_place.Ur5Moveit.set_joint_angles">[docs]</a>    <span class="k">def</span> <span class="nf">set_joint_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list_joint_angles</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set joint angles of arm to pre defined joint angles</span>

<span class="sd">        :param arg_list_joint_angles: list of goal joint angles of UR5 arm in radians</span>
<span class="sd">        :type arg_list_joint_angles: list</span>
<span class="sd">        :return: Success flag</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="o">.</span><span class="n">set_joint_value_target</span><span class="p">(</span><span class="n">arg_list_joint_angles</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_computed_plan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="o">.</span><span class="n">plan</span><span class="p">()</span>
        <span class="n">flag_plan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_computed_plan</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">flag_plan</span></div>

<div class="viewcode-block" id="Ur5Moveit.hard_set_joint_angles"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_2_place.html#node_ur5_2_place.Ur5Moveit.hard_set_joint_angles">[docs]</a>    <span class="k">def</span> <span class="nf">hard_set_joint_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_list_joint_angles</span><span class="p">,</span> <span class="n">arg_max_attempts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Try to set the joint angles again and again until success or max attempts exhausted</span>

<span class="sd">        :param arg_list_joint_angles: list of goal joint angles of UR5 arm in radians</span>
<span class="sd">        :type arg_list_joint_angles: list</span>
<span class="sd">        :param arg_max_attempts: maximum number of attempts to try</span>
<span class="sd">        :type arg_max_attempts: int</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">number_attempts</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">flag_success</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">while</span> <span class="n">number_attempts</span> <span class="o">&lt;=</span> <span class="n">arg_max_attempts</span> <span class="ow">and</span> <span class="n">flag_success</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">number_attempts</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">flag_success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_joint_angles</span><span class="p">(</span><span class="n">arg_list_joint_angles</span><span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="s2">&quot;attempts: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number_attempts</span><span class="p">))</span></div>

<div class="viewcode-block" id="Ur5Moveit.attach_box"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_2_place.html#node_ur5_2_place.Ur5Moveit.attach_box">[docs]</a>    <span class="k">def</span> <span class="nf">attach_box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">box_name</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attach box received in arguments to arm in RViz</span>

<span class="sd">        :param box_name: name of box to attach</span>
<span class="sd">        :type box_name: str</span>
<span class="sd">        :param timeout: time(s) to wait for state update else return False</span>
<span class="sd">        :type timeout: int</span>
<span class="sd">        :return: Success Flag</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">grasping_group</span> <span class="o">=</span> <span class="s1">&#39;manipulator&#39;</span>
        <span class="n">touch_links</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_robot</span><span class="o">.</span><span class="n">get_link_names</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="n">grasping_group</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scene</span><span class="o">.</span><span class="n">attach_box</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_eef_link</span><span class="p">,</span> <span class="n">box_name</span><span class="p">,</span> <span class="n">touch_links</span><span class="o">=</span><span class="n">touch_links</span><span class="p">)</span>

        <span class="c1"># We wait for the planning scene to update.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_state_update</span><span class="p">(</span><span class="n">box_is_attached</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">box_is_known</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span></div>

<div class="viewcode-block" id="Ur5Moveit.detach_box"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_2_place.html#node_ur5_2_place.Ur5Moveit.detach_box">[docs]</a>    <span class="k">def</span> <span class="nf">detach_box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">box_name</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Detach box received in arguments to arm in RViz</span>

<span class="sd">        :param box_name: name of box to detach</span>
<span class="sd">        :type box_name: str</span>
<span class="sd">        :param timeout: time(s) to wait for state update else return False</span>
<span class="sd">        :type timeout: int</span>
<span class="sd">        :return: Success Flag</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scene</span><span class="o">.</span><span class="n">remove_attached_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_eef_link</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">box_name</span><span class="p">)</span>

        <span class="c1"># We wait for the planning scene to update.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_state_update</span><span class="p">(</span><span class="n">box_is_known</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">box_is_attached</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span></div>

<div class="viewcode-block" id="Ur5Moveit.attach_box_in_gazebo"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_2_place.html#node_ur5_2_place.Ur5Moveit.attach_box_in_gazebo">[docs]</a>    <span class="k">def</span> <span class="nf">attach_box_in_gazebo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Activate vacuum gripper of arm in gazebo</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">wait_for_service</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vacuum_gripper_service</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">activate_vacuum_gripper</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceProxy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vacuum_gripper_service</span><span class="p">,</span> <span class="n">vacuumGripper</span><span class="p">)</span>
            <span class="n">resp1</span> <span class="o">=</span> <span class="n">activate_vacuum_gripper</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">resp1</span><span class="o">.</span><span class="n">result</span>
        <span class="k">except</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceException</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Service call failed: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">exception</span><span class="p">)</span></div>

<div class="viewcode-block" id="Ur5Moveit.detach_box_in_gazebo"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_2_place.html#node_ur5_2_place.Ur5Moveit.detach_box_in_gazebo">[docs]</a>    <span class="k">def</span> <span class="nf">detach_box_in_gazebo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deactivate vacuum gripper of arm in gazebo</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">wait_for_service</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vacuum_gripper_service</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">activate_vacuum_gripper</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceProxy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vacuum_gripper_service</span><span class="p">,</span> <span class="n">vacuumGripper</span><span class="p">)</span>
            <span class="n">resp1</span> <span class="o">=</span> <span class="n">activate_vacuum_gripper</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">resp1</span><span class="o">.</span><span class="n">result</span>
        <span class="k">except</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceException</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Service call failed: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">exception</span><span class="p">)</span></div>

<div class="viewcode-block" id="Ur5Moveit.remove_box"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_2_place.html#node_ur5_2_place.Ur5Moveit.remove_box">[docs]</a>    <span class="k">def</span> <span class="nf">remove_box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">box_name</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove box from planning scene in RViz</span>

<span class="sd">        :param box_name: name of box to remove</span>
<span class="sd">        :type box_name: str</span>
<span class="sd">        :param timeout: time(s) to wait for state update else return False</span>
<span class="sd">        :type timeout: int</span>
<span class="sd">        :return: Success flag</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scene</span><span class="o">.</span><span class="n">remove_world_object</span><span class="p">(</span><span class="n">box_name</span><span class="p">)</span>

        <span class="c1"># We wait for the planning scene to update.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_state_update</span><span class="p">(</span><span class="n">box_is_attached</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                          <span class="n">box_is_known</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                          <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span></div>

<div class="viewcode-block" id="Ur5Moveit.wait_for_state_update"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_2_place.html#node_ur5_2_place.Ur5Moveit.wait_for_state_update">[docs]</a>    <span class="k">def</span> <span class="nf">wait_for_state_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">box_is_known</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">box_is_attached</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wait before all the required changes are made in the planning scene in RViz</span>

<span class="sd">        :param box_is_known: Flag whether the box is present in planning scene or not</span>
<span class="sd">        :type box_is_known: bool</span>
<span class="sd">        :param box_is_attached: flag whether the box is attached to arm or not in RViz</span>
<span class="sd">        :type box_is_attached: bool</span>
<span class="sd">        :param timeout: time(s) to wait for the state to update</span>
<span class="sd">        :type timeout: int</span>
<span class="sd">        :return: success flag</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">()</span>
        <span class="n">seconds</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">()</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">seconds</span> <span class="o">-</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">rospy</span><span class="o">.</span><span class="n">is_shutdown</span><span class="p">():</span>
            <span class="c1"># Test if the box is in attached objects</span>
            <span class="n">attached_objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scene</span><span class="o">.</span><span class="n">get_attached_objects</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_box_name</span><span class="p">])</span>
            <span class="n">is_attached</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">attached_objects</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="c1"># Test if the box is in the scene.</span>
            <span class="c1"># Note that attaching the box will remove it from known_objects</span>
            <span class="n">is_known</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_box_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scene</span><span class="o">.</span><span class="n">get_known_object_names</span><span class="p">()</span>

            <span class="c1"># Test if we are in the expected state</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">box_is_attached</span> <span class="o">==</span> <span class="n">is_attached</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">box_is_known</span> <span class="o">==</span> <span class="n">is_known</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>

            <span class="c1"># Sleep so that we give other threads time on the processor</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">seconds</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">()</span>

        <span class="c1"># If we exited the while loop without returning then we timed out</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Ur5Moveit.play_saved_trajectory"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_2_place.html#node_ur5_2_place.Ur5Moveit.play_saved_trajectory">[docs]</a>    <span class="k">def</span> <span class="nf">play_saved_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_file_path</span><span class="p">,</span> <span class="n">arg_file_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Play a trajectory which was saved before</span>

<span class="sd">        :param arg_file_path: Path to folder where trajectories are saved</span>
<span class="sd">        :type arg_file_path: str</span>
<span class="sd">        :param arg_file_name: Name of the trajectory to be played</span>
<span class="sd">        :type arg_file_name: str</span>
<span class="sd">        :return: success flag</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">arg_file_path</span> <span class="o">+</span> <span class="n">arg_file_name</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_open</span><span class="p">:</span>
            <span class="n">loaded_plan</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_open</span><span class="p">)</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">loaded_plan</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="Ur5Moveit.hard_play_saved_trajectory"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_2_place.html#node_ur5_2_place.Ur5Moveit.hard_play_saved_trajectory">[docs]</a>    <span class="k">def</span> <span class="nf">hard_play_saved_trajectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_file_path</span><span class="p">,</span> <span class="n">arg_file_name</span><span class="p">,</span> <span class="n">arg_max_attempts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Play a saved trajectory by loading it from a file again and again until success or</span>
<span class="sd">        max attempts exhausted</span>

<span class="sd">        :param arg_file_path: Path to the saved trajectories folder</span>
<span class="sd">        :type arg_file_path: str</span>
<span class="sd">        :param arg_file_name: Name of the trajectory .yaml file</span>
<span class="sd">        :type arg_file_name: str</span>
<span class="sd">        :param arg_max_attempts: Number of attempts to try playing it until success</span>
<span class="sd">        :type arg_max_attempts: int</span>
<span class="sd">        :return: Success flag</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">number_attempts</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">flag_success</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">while</span> <span class="n">number_attempts</span> <span class="o">&lt;=</span> <span class="n">arg_max_attempts</span> <span class="ow">and</span> <span class="n">flag_success</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">number_attempts</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">flag_success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">play_saved_trajectory</span><span class="p">(</span><span class="n">arg_file_path</span><span class="p">,</span> <span class="n">arg_file_name</span><span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="s2">&quot;attempts: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number_attempts</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">flag_success</span></div>

    <span class="c1"># Destructor</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">moveit_commander</span><span class="o">.</span><span class="n">roscpp_shutdown</span><span class="p">()</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[94m&#39;</span> <span class="o">+</span> <span class="s2">&quot;Object of class Ur5Moveit Deleted.&quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="OrderDetails"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_2_place.html#node_ur5_2_place.OrderDetails">[docs]</a><span class="k">class</span> <span class="nc">OrderDetails</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to store details of the package coming on conveyor belt from UR5_1</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">colour</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">details</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch_time</span> <span class="o">=</span> <span class="mi">0</span>

<div class="viewcode-block" id="OrderDetails.set_name"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_2_place.html#node_ur5_2_place.OrderDetails.set_name">[docs]</a>    <span class="k">def</span> <span class="nf">set_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set name of package.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span></div>

<div class="viewcode-block" id="OrderDetails.set_colour"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_2_place.html#node_ur5_2_place.OrderDetails.set_colour">[docs]</a>    <span class="k">def</span> <span class="nf">set_colour</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colour</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set colour of the package.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">colour</span> <span class="o">=</span> <span class="n">colour</span></div>

<div class="viewcode-block" id="OrderDetails.set_details"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_2_place.html#node_ur5_2_place.OrderDetails.set_details">[docs]</a>    <span class="k">def</span> <span class="nf">set_details</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">details</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set other details of package like City, Cost, etc.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">details</span> <span class="o">=</span> <span class="n">details</span></div>

<div class="viewcode-block" id="OrderDetails.set_dispatch_time"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_2_place.html#node_ur5_2_place.OrderDetails.set_dispatch_time">[docs]</a>    <span class="k">def</span> <span class="nf">set_dispatch_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dispatch_time</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set dispatch time(s) of the package.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch_time</span> <span class="o">=</span> <span class="n">dispatch_time</span></div></div>


<div class="viewcode-block" id="RosIotBridgeActionClient"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_2_place.html#node_ur5_2_place.RosIotBridgeActionClient">[docs]</a><span class="k">class</span> <span class="nc">RosIotBridgeActionClient</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Action Client to act as a bridge between ROS Nodes and IOT to update</span>
<span class="sd">    google spreadsheets</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Constructor</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># Initialize Action Client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ac</span> <span class="o">=</span> <span class="n">actionlib</span><span class="o">.</span><span class="n">ActionClient</span><span class="p">(</span><span class="s1">&#39;/action_ros_iot&#39;</span><span class="p">,</span>
                                          <span class="n">msgRosIotAction</span><span class="p">)</span>

        <span class="c1"># Dictionary to Store all the goal handels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_goal_handles</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Store the MQTT Topic on which to Publish in a variable</span>
        <span class="n">param_config_iot</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;config_pyiot&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_config_mqtt_pub_topic</span> <span class="o">=</span> <span class="n">param_config_iot</span><span class="p">[</span><span class="s1">&#39;mqtt&#39;</span><span class="p">][</span><span class="s1">&#39;topic_pub&#39;</span><span class="p">]</span>

        <span class="c1"># Wait for Action Server that will use the action - &#39;/action_iot_ros&#39; to start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ac</span><span class="o">.</span><span class="n">wait_for_server</span><span class="p">()</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s2">&quot;Action server up, we can send goals.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="RosIotBridgeActionClient.on_transition"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_2_place.html#node_ur5_2_place.RosIotBridgeActionClient.on_transition">[docs]</a>    <span class="k">def</span> <span class="nf">on_transition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">goal_handle</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function will be called when there is change of state in the Action Client State</span>
<span class="sd">        Machine</span>

<span class="sd">        :param goal_handle: unique id of goal</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># from on_goal() to on_transition(). goal_handle generated by send_goal() is used here.</span>

        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_goal_handles</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_goal_handles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">goal_handle</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">break</span>

        <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s2">&quot;Transition Callback. Client Goal Handle #: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s2">&quot;Comm. State: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">goal_handle</span><span class="o">.</span><span class="n">get_comm_state</span><span class="p">()))</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s2">&quot;Goal Status: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">goal_handle</span><span class="o">.</span><span class="n">get_goal_status</span><span class="p">()))</span>

        <span class="c1"># Comm State - Monitors the State Machine of the Client which is different from Server&#39;s</span>
        <span class="c1"># Comm State = 2 -&gt; Active</span>
        <span class="c1"># Comm State = 3 -&gt; Wating for Result</span>
        <span class="c1"># Comm State = 7 -&gt; Done</span>

        <span class="c1"># if (Comm State == ACTIVE)</span>
        <span class="k">if</span> <span class="n">goal_handle</span><span class="o">.</span><span class="n">get_comm_state</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: Goal just went active.&quot;</span><span class="p">)</span>

        <span class="c1"># if (Comm State == DONE)</span>
        <span class="k">if</span> <span class="n">goal_handle</span><span class="o">.</span><span class="n">get_comm_state</span><span class="p">()</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: Goal is DONE&quot;</span><span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="n">goal_handle</span><span class="o">.</span><span class="n">get_terminal_state</span><span class="p">())</span>

            <span class="c1"># get_result() gets the result produced by the Action Server</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">goal_handle</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">flag_success</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">flag_success</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s2">&quot;Goal successfully completed. Client Goal Handle #: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s2">&quot;Goal failed. Client Goal Handle #: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span></div>

<div class="viewcode-block" id="RosIotBridgeActionClient.send_goal"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_2_place.html#node_ur5_2_place.RosIotBridgeActionClient.send_goal">[docs]</a>    <span class="k">def</span> <span class="nf">send_goal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_protocol</span><span class="p">,</span> <span class="n">arg_mode</span><span class="p">,</span> <span class="n">arg_topic</span><span class="p">,</span> <span class="n">arg_message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function is used to send Goals to Action Server</span>

<span class="sd">        :param arg_protocol: IoT protocol to follow (HTTP, MQTT, etc.)</span>
<span class="sd">        :type arg_protocol: str</span>
<span class="sd">        :param arg_mode: Mode whether to publish or subscribe</span>
<span class="sd">        :type arg_mode: str</span>
<span class="sd">        :param arg_topic: Topic to subscribe or publish to</span>
<span class="sd">        :type arg_topic: str</span>
<span class="sd">        :param arg_message: Message to push or publish</span>
<span class="sd">        :type arg_message: str</span>
<span class="sd">        :return: goal handle</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create a Goal Message object</span>
        <span class="n">goal</span> <span class="o">=</span> <span class="n">msgRosIotGoal</span><span class="p">()</span>

        <span class="n">goal</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">arg_protocol</span>
        <span class="n">goal</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">arg_mode</span>
        <span class="n">goal</span><span class="o">.</span><span class="n">topic</span> <span class="o">=</span> <span class="n">arg_topic</span>
        <span class="n">goal</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">arg_message</span>

        <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s2">&quot;Send goal.&quot;</span><span class="p">)</span>

        <span class="c1"># self.on_transition - It is a function pointer to a function which will be called when</span>
        <span class="c1">#                       there is a change of state in the Action Client State Machine</span>
        <span class="n">goal_handle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ac</span><span class="o">.</span><span class="n">send_goal</span><span class="p">(</span><span class="n">goal</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">on_transition</span><span class="p">,</span>
                                         <span class="kc">None</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">goal_handle</span></div></div>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_2_place.html#node_ur5_2_place.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main node to control UR5_2 arm.</span>

<span class="sd">    This function is called to start the pick and place operation of UR5_2 arm.</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Initialize the node</span>
    <span class="n">rospy</span><span class="o">.</span><span class="n">init_node</span><span class="p">(</span><span class="s1">&#39;node_ur5_2_place&#39;</span><span class="p">)</span>

    <span class="c1"># Wait for models to spawn in gazebo</span>
    <span class="k">while</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
        <span class="k">continue</span>

    <span class="c1"># Initialize an object of type Ur5Moveit to control ur5_2</span>
    <span class="n">ur5_2</span> <span class="o">=</span> <span class="n">Ur5Moveit</span><span class="p">(</span><span class="s1">&#39;ur5_2&#39;</span><span class="p">)</span>

    <span class="n">order</span> <span class="o">=</span> <span class="n">OrderDetails</span><span class="p">()</span>

    <span class="n">orders_drop_time_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Action Client initialized</span>
    <span class="n">action_client</span> <span class="o">=</span> <span class="n">RosIotBridgeActionClient</span><span class="p">()</span>

    <span class="c1"># Subscribe topic to get data of incoming package</span>
    <span class="n">rospy</span><span class="o">.</span><span class="n">Subscriber</span><span class="p">(</span><span class="s2">&quot;eyrc/vb/dispatched_pkg&quot;</span><span class="p">,</span>      <span class="c1"># Ros topic to subscribe</span>
                     <span class="n">DispatchedPackage</span><span class="p">,</span>           <span class="c1"># Message type</span>
                     <span class="n">dispatched_pkg_callback</span><span class="p">,</span>     <span class="c1"># Callback function name</span>
                     <span class="p">(</span><span class="n">ur5_2</span><span class="p">,</span> <span class="n">order</span><span class="p">))</span>              <span class="c1"># Arguments to pass to callback function</span>

    <span class="c1"># Subscribe topic to get data of objects under logical camera 2</span>
    <span class="n">rospy</span><span class="o">.</span><span class="n">Subscriber</span><span class="p">(</span><span class="s1">&#39;/eyrc/vb/logical_camera_2&#39;</span><span class="p">,</span>
                     <span class="n">LogicalCameraImage</span><span class="p">,</span>
                     <span class="n">logical_camera_2_callback</span><span class="p">,</span>
                     <span class="n">ur5_2</span><span class="p">)</span>

    <span class="c1"># To store number of packages dropped in the bins</span>
    <span class="n">total_pkg_dropped</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">prev_bin</span> <span class="o">=</span> <span class="n">ur5_2</span><span class="o">.</span><span class="n">prev_bin</span>

    <span class="c1"># Go to home position #1</span>
    <span class="n">go_to_home</span><span class="p">(</span><span class="n">ur5_2</span><span class="p">)</span>

    <span class="c1"># Main loop to drop the packages in the bin</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># Break the loop once all 9 packages have been dropped</span>
        <span class="k">if</span> <span class="n">total_pkg_dropped</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="c1"># If a package is coming</span>
        <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">ur5_2</span><span class="o">.</span><span class="n">orders_list</span><span class="p">):</span>

            <span class="c1"># Get the colour of the incoming package</span>
            <span class="n">current_pkg_colour</span> <span class="o">=</span> <span class="n">ur5_2</span><span class="o">.</span><span class="n">orders_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">colour</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Colour: &quot;</span><span class="p">,</span> <span class="n">current_pkg_colour</span><span class="p">)</span>

            <span class="c1"># Find the appropriate home position to go</span>
            <span class="n">appropriate_home_pose</span> <span class="o">=</span> <span class="n">find_appropriate_home_position</span><span class="p">(</span><span class="n">current_pkg_colour</span><span class="p">,</span>
                                                                   <span class="n">prev_bin</span><span class="p">,</span>
                                                                   <span class="n">ur5_2</span><span class="p">)</span>

            <span class="c1"># Go to the appropriate home position</span>
            <span class="n">go_to_home_position</span><span class="p">(</span><span class="n">appropriate_home_pose</span><span class="p">,</span> <span class="n">current_pkg_colour</span><span class="p">,</span> <span class="n">prev_bin</span><span class="p">,</span> <span class="n">ur5_2</span><span class="p">)</span>

            <span class="c1"># Assign colour of the bin to drop the package in</span>
            <span class="n">ur5_2</span><span class="o">.</span><span class="n">next_bin</span> <span class="o">=</span> <span class="n">current_pkg_colour</span>

            <span class="n">file_name</span> <span class="o">=</span> <span class="n">ur5_2</span><span class="o">.</span><span class="n">home</span> <span class="o">+</span> <span class="s1">&#39;_to_&#39;</span> <span class="o">+</span> <span class="n">current_pkg_colour</span> <span class="o">+</span> <span class="s1">&#39;_bin.yaml&#39;</span>

            <span class="c1"># Wait for the package to come at the right position to be picked up</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Waiting&quot;</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">ur5_2</span><span class="o">.</span><span class="n">pkg_not_pickable</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Print the colour of the package</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Waiting Complete&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">current_pkg_colour</span><span class="p">)</span>

            <span class="c1"># Attach the package to the vacuum gripper to ur5_2</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Attaching box&quot;</span><span class="p">)</span>
            <span class="n">ur5_2</span><span class="o">.</span><span class="n">attach_box_in_gazebo</span><span class="p">()</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

            <span class="n">ur5_2</span><span class="o">.</span><span class="n">home_position_updated</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># start the conveyor belt again at full speed after picking the package</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting Conveyor belt&quot;</span><span class="p">)</span>
            <span class="n">start_conveyor_belt</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

            <span class="c1"># Play the saved trajectory to drop package in the respective bin</span>
            <span class="n">ur5_2</span><span class="o">.</span><span class="n">hard_play_saved_trajectory</span><span class="p">(</span><span class="n">ur5_2</span><span class="o">.</span><span class="n">get_file_path</span><span class="p">(),</span> <span class="n">file_name</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

            <span class="c1"># Deactivate the vacuum gripper to drop the package</span>
            <span class="n">ur5_2</span><span class="o">.</span><span class="n">detach_box_in_gazebo</span><span class="p">()</span>

            <span class="n">orders_drop_time_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">ur5_2</span><span class="o">.</span><span class="n">orders_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">()])</span>

            <span class="n">update_orders_shipped_sheet</span><span class="p">(</span><span class="n">ur5_2</span><span class="o">.</span><span class="n">orders_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">details</span><span class="p">,</span> <span class="n">action_client</span><span class="p">)</span>

            <span class="n">prev_bin</span> <span class="o">=</span> <span class="n">ur5_2</span><span class="o">.</span><span class="n">next_bin</span>

            <span class="c1"># Calculate the time lapsed since the package dropped by the ur5_1 arm</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ur5_2</span><span class="o">.</span><span class="n">orders_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">current_time</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">()</span>
                <span class="n">ur5_2</span><span class="o">.</span><span class="n">time_lapsed_since_dispatch</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">-</span> <span class="n">ur5_2</span><span class="o">.</span><span class="n">orders_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dispatch_time</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time lapsed since dispatch: &quot;</span><span class="p">,</span> <span class="n">ur5_2</span><span class="o">.</span><span class="n">time_lapsed_since_dispatch</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ur5_2</span><span class="o">.</span><span class="n">time_lapsed_since_dispatch</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">total_pkg_dropped</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">ur5_2</span><span class="o">.</span><span class="n">pkg_detected</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">ur5_2</span><span class="o">.</span><span class="n">pkg_not_pickable</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">ur5_2</span><span class="o">.</span><span class="n">orders_list</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>


<span class="c1"># Incoming package callback</span>
<div class="viewcode-block" id="dispatched_pkg_callback"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_2_place.html#node_ur5_2_place.dispatched_pkg_callback">[docs]</a><span class="k">def</span> <span class="nf">dispatched_pkg_callback</span><span class="p">(</span><span class="n">pkg</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called whenever a package is dispatched by UR5_1 arm.</span>

<span class="sd">    This function notes the time when the package was dispatched to decide the home</span>
<span class="sd">    position of UR5_2 arm to go to pickup the package and append a deepcopy of the</span>
<span class="sd">    order details to orders_list and notify the details on the terminal as well</span>

<span class="sd">    :param pkg: Dispatched package</span>
<span class="sd">    :type pkg: DispatchedPackage</span>
<span class="sd">    :param args: Orders list</span>
<span class="sd">    :type args: list</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ur5_2</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">order</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">order</span><span class="o">.</span><span class="n">set_colour</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">colour</span><span class="p">)</span>
    <span class="n">order</span><span class="o">.</span><span class="n">set_details</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">order_details</span><span class="p">)</span>
    <span class="n">order</span><span class="o">.</span><span class="n">set_dispatch_time</span><span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">())</span>

    <span class="n">ur5_2</span><span class="o">.</span><span class="n">orders_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">order</span><span class="p">))</span>

    <span class="c1"># Print the details of incoming package on terminal</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;######### Package Coming ###########&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Name: packagen&quot;</span> <span class="o">+</span> <span class="n">pkg</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Colour: &quot;</span><span class="p">,</span> <span class="n">pkg</span><span class="o">.</span><span class="n">colour</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Order Details: &quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">pkg</span><span class="o">.</span><span class="n">order_details</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="logical_camera_2_callback"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_2_place.html#node_ur5_2_place.logical_camera_2_callback">[docs]</a><span class="k">def</span> <span class="nf">logical_camera_2_callback</span><span class="p">(</span><span class="n">logical_camera_image</span><span class="p">,</span> <span class="n">ur5_2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function handles the job to stop the incoming package at the right location</span>
<span class="sd">    on the conveyor belt to keep the conveyor belt moving most of the time.</span>

<span class="sd">    :param logical_camera_image: Data captured by logical camera over conveyor belt</span>
<span class="sd">    :type logical_camera_image: LogicalCameraImage</span>
<span class="sd">    :param ur5_2: Object having details of UR5_2 arm</span>
<span class="sd">    :type ur5_2: Object of class Ur5Moveit</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># If a model is detected by the logical camera</span>
    <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">logical_camera_image</span><span class="o">.</span><span class="n">models</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">bool</span><span class="p">(</span><span class="n">ur5_2</span><span class="o">.</span><span class="n">orders_list</span><span class="p">):</span>

        <span class="c1"># Iterate through all the models detected by the logical camera</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">logical_camera_image</span><span class="o">.</span><span class="n">models</span><span class="p">:</span>
            <span class="c1"># If home position is updated and a package is found under logical camera</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ur5_2</span><span class="o">.</span><span class="n">home_position_updated</span> <span class="ow">and</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;packagen&quot;</span> <span class="o">+</span> <span class="n">ur5_2</span><span class="o">.</span><span class="n">orders_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>

                <span class="k">if</span> <span class="n">ur5_2</span><span class="o">.</span><span class="n">home</span> <span class="o">==</span> <span class="s1">&#39;home_1&#39;</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ur5_2</span><span class="o">.</span><span class="n">pkg_detected</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">stop_conveyor_belt</span><span class="p">()</span>
                        <span class="n">ur5_2</span><span class="o">.</span><span class="n">pkg_detected</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">ur5_2</span><span class="o">.</span><span class="n">pkg_not_pickable</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="n">ur5_2</span><span class="o">.</span><span class="n">home</span> <span class="o">==</span> <span class="s1">&#39;home_2&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mf">0.06</span> <span class="ow">and</span> <span class="n">ur5_2</span><span class="o">.</span><span class="n">pkg_detected</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">stop_conveyor_belt</span><span class="p">()</span>
                        <span class="n">ur5_2</span><span class="o">.</span><span class="n">pkg_detected</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">ur5_2</span><span class="o">.</span><span class="n">pkg_not_pickable</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="n">ur5_2</span><span class="o">.</span><span class="n">home</span> <span class="o">==</span> <span class="s1">&#39;home_3&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.22</span> <span class="ow">and</span> <span class="n">ur5_2</span><span class="o">.</span><span class="n">pkg_detected</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">stop_conveyor_belt</span><span class="p">()</span>
                        <span class="n">ur5_2</span><span class="o">.</span><span class="n">pkg_detected</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">ur5_2</span><span class="o">.</span><span class="n">pkg_not_pickable</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="update_orders_shipped_sheet"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_2_place.html#node_ur5_2_place.update_orders_shipped_sheet">[docs]</a><span class="k">def</span> <span class="nf">update_orders_shipped_sheet</span><span class="p">(</span><span class="n">order_details</span><span class="p">,</span> <span class="n">action_client</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update the Shipped google spreadsheet by sending goal to the Ros-Iot Bridge</span>
<span class="sd">    Action Server</span>

<span class="sd">    :param order_details: Details of the shipped order</span>
<span class="sd">    :type order_details: json object</span>
<span class="sd">    :param action_client: Action client to send goal to the action server</span>
<span class="sd">    :type action_client: Object of class RosIotBridgeActionClient</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">order_details</span><span class="p">)</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>
    <span class="n">str_time</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>

    <span class="n">team_id</span> <span class="o">=</span> <span class="s2">&quot;VB#0574&quot;</span>
    <span class="n">unique_id</span> <span class="o">=</span> <span class="s2">&quot;isPicuTP&quot;</span>

    <span class="k">if</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;Item&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Medicine&#39;</span><span class="p">:</span>
        <span class="n">priority</span> <span class="o">=</span> <span class="s1">&#39;HP&#39;</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="mi">450</span>
        <span class="n">days_till_delivery</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;Item&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Food&#39;</span><span class="p">:</span>
        <span class="n">priority</span> <span class="o">=</span> <span class="s1">&#39;MP&#39;</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="mi">250</span>
        <span class="n">days_till_delivery</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">priority</span> <span class="o">=</span> <span class="s1">&#39;LP&#39;</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="mi">150</span>
        <span class="n">days_till_delivery</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

    <span class="n">estimated_date_of_delivery</span> <span class="o">=</span> <span class="n">value</span> <span class="o">+</span> <span class="n">days_till_delivery</span>
    <span class="n">estimated_date_of_delivery</span> <span class="o">=</span> <span class="n">estimated_date_of_delivery</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;OrdersShipped&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;Team Id&quot;</span><span class="p">:</span> <span class="n">team_id</span><span class="p">,</span>
                  <span class="s2">&quot;Unique Id&quot;</span><span class="p">:</span> <span class="n">unique_id</span><span class="p">,</span>
                  <span class="s2">&quot;Order ID&quot;</span><span class="p">:</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;Order ID&#39;</span><span class="p">],</span>
                  <span class="s2">&quot;City&quot;</span><span class="p">:</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;City&#39;</span><span class="p">],</span>
                  <span class="s2">&quot;Item&quot;</span><span class="p">:</span> <span class="n">order</span><span class="p">[</span><span class="s1">&#39;Item&#39;</span><span class="p">],</span>
                  <span class="s2">&quot;Priority&quot;</span><span class="p">:</span> <span class="n">priority</span><span class="p">,</span>
                  <span class="s2">&quot;Shipped Quantity&quot;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
                  <span class="s2">&quot;Cost&quot;</span><span class="p">:</span> <span class="n">cost</span><span class="p">,</span>
                  <span class="s2">&quot;Shipped Status&quot;</span><span class="p">:</span> <span class="s2">&quot;Yes&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;Shipped Date and Time&quot;</span><span class="p">:</span> <span class="n">str_time</span><span class="p">,</span>
                  <span class="s2">&quot;Estimated Time of Delivery&quot;</span><span class="p">:</span> <span class="n">estimated_date_of_delivery</span><span class="p">}</span>

    <span class="c1"># Send data to our spreadsheet</span>
    <span class="n">action_client</span><span class="o">.</span><span class="n">send_goal</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="s2">&quot;NA&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">parameters</span><span class="p">))</span>

    <span class="c1"># Send data to eyantra&#39;s spreadsheet</span>
    <span class="n">action_client</span><span class="o">.</span><span class="n">send_goal</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="s2">&quot;eyantra&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">parameters</span><span class="p">))</span></div>


<div class="viewcode-block" id="start_conveyor_belt"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_2_place.html#node_ur5_2_place.start_conveyor_belt">[docs]</a><span class="k">def</span> <span class="nf">start_conveyor_belt</span><span class="p">(</span><span class="n">power</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to start the conveyor belt at a certain power</span>

<span class="sd">    :param power: power of the belt to be set</span>
<span class="sd">    :type power: int</span>
<span class="sd">    :return: success flag</span>
<span class="sd">    :rtype: bool</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rospy</span><span class="o">.</span><span class="n">wait_for_service</span><span class="p">(</span><span class="s1">&#39;/eyrc/vb/conveyor/set_power&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">power_service</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceProxy</span><span class="p">(</span><span class="s1">&#39;/eyrc/vb/conveyor/set_power&#39;</span><span class="p">,</span> <span class="n">conveyorBeltPowerMsg</span><span class="p">)</span>
        <span class="n">resp1</span> <span class="o">=</span> <span class="n">power_service</span><span class="p">(</span><span class="n">power</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resp1</span><span class="o">.</span><span class="n">result</span>

    <span class="k">except</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceException</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Service call failed: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">exception</span><span class="p">)</span></div>


<div class="viewcode-block" id="stop_conveyor_belt"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_2_place.html#node_ur5_2_place.stop_conveyor_belt">[docs]</a><span class="k">def</span> <span class="nf">stop_conveyor_belt</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to stop the conveyor belt</span>

<span class="sd">    :return: Success flag</span>
<span class="sd">    :rtype: bool</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rospy</span><span class="o">.</span><span class="n">wait_for_service</span><span class="p">(</span><span class="s1">&#39;/eyrc/vb/conveyor/set_power&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">power</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceProxy</span><span class="p">(</span><span class="s1">&#39;/eyrc/vb/conveyor/set_power&#39;</span><span class="p">,</span> <span class="n">conveyorBeltPowerMsg</span><span class="p">)</span>
        <span class="n">resp1</span> <span class="o">=</span> <span class="n">power</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resp1</span><span class="o">.</span><span class="n">result</span>

    <span class="k">except</span> <span class="n">rospy</span><span class="o">.</span><span class="n">ServiceException</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Service call failed: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">exception</span><span class="p">)</span></div>


<div class="viewcode-block" id="go_to_home"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_2_place.html#node_ur5_2_place.go_to_home">[docs]</a><span class="k">def</span> <span class="nf">go_to_home</span><span class="p">(</span><span class="n">ur5_2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Move UR5_2 arm to home position #1&quot;&quot;&quot;</span>

    <span class="c1"># Home position #1</span>
    <span class="n">ur5_2_home1</span> <span class="o">=</span> <span class="p">[</span><span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="o">-</span><span class="mi">29</span><span class="p">),</span>
                   <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="o">-</span><span class="mi">139</span><span class="p">),</span>
                   <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="o">-</span><span class="mi">60</span><span class="p">),</span>
                   <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="o">-</span><span class="mi">71</span><span class="p">),</span>
                   <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">90</span><span class="p">),</span>
                   <span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="o">-</span><span class="mi">32</span><span class="p">)]</span>

    <span class="n">ur5_2</span><span class="o">.</span><span class="n">hard_set_joint_angles</span><span class="p">(</span><span class="n">ur5_2_home1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span></div>


<div class="viewcode-block" id="find_appropriate_home_position"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_2_place.html#node_ur5_2_place.find_appropriate_home_position">[docs]</a><span class="k">def</span> <span class="nf">find_appropriate_home_position</span><span class="p">(</span><span class="n">current_pkg_color</span><span class="p">,</span> <span class="n">prev_bin</span><span class="p">,</span> <span class="n">ur5_2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Move the UR5_2 arm to correct position over conveyor belt so that conveyor belt</span>
<span class="sd">    stays on for most of the time and need to stop it only momentarily</span>

<span class="sd">    This is achieved by noting the time elapsed since the package is dispatched to</span>
<span class="sd">    determine the current position of package on conveyor belt. This information is used to</span>
<span class="sd">    determine whether the arm can return to home position #1 before package reaches there. if not,</span>
<span class="sd">    then arm will be moved to home position #2.</span>

<span class="sd">    :param current_pkg_color:  Colour of the next package coming on conveyor belt</span>
<span class="sd">    :type current_pkg_color: str</span>
<span class="sd">    :param prev_bin: Colour of bin from where it will go to home position</span>
<span class="sd">    :type prev_bin: str</span>
<span class="sd">    :param ur5_2: Ur5Moveit object to control UR5_2 arm</span>
<span class="sd">    :type ur5_2: Object of class Ur5Moveit</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">appropriate_home_pose</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">if</span> <span class="n">prev_bin</span> <span class="o">==</span> <span class="s1">&#39;red&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">current_pkg_color</span> <span class="o">==</span> <span class="s1">&#39;red&#39;</span> <span class="ow">or</span> <span class="n">current_pkg_color</span> <span class="o">==</span> <span class="s1">&#39;yellow&#39;</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="n">ur5_2</span><span class="o">.</span><span class="n">time_lapsed_since_dispatch</span> <span class="o">&lt;</span> <span class="mf">5.3</span><span class="p">:</span>
            <span class="n">appropriate_home_pose</span> <span class="o">=</span> <span class="s1">&#39;home_1&#39;</span>
        <span class="k">elif</span> <span class="n">current_pkg_color</span> <span class="o">==</span> <span class="s1">&#39;green&#39;</span><span class="p">:</span>
            <span class="n">appropriate_home_pose</span> <span class="o">=</span> <span class="s1">&#39;home_3&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">appropriate_home_pose</span> <span class="o">=</span> <span class="s1">&#39;home_2&#39;</span>

    <span class="k">elif</span> <span class="n">prev_bin</span> <span class="o">==</span> <span class="s1">&#39;yellow&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">current_pkg_color</span> <span class="o">==</span> <span class="s1">&#39;red&#39;</span> <span class="ow">or</span> <span class="n">current_pkg_color</span> <span class="o">==</span> <span class="s1">&#39;yellow&#39;</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="n">ur5_2</span><span class="o">.</span><span class="n">time_lapsed_since_dispatch</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">appropriate_home_pose</span> <span class="o">=</span> <span class="s1">&#39;home_1&#39;</span>
        <span class="k">elif</span> <span class="n">current_pkg_color</span> <span class="o">==</span> <span class="s1">&#39;green&#39;</span><span class="p">:</span>
            <span class="n">appropriate_home_pose</span> <span class="o">=</span> <span class="s1">&#39;home_3&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">appropriate_home_pose</span> <span class="o">=</span> <span class="s1">&#39;home_2&#39;</span>

    <span class="k">elif</span> <span class="n">prev_bin</span> <span class="o">==</span> <span class="s1">&#39;green&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">current_pkg_color</span> <span class="o">==</span> <span class="s1">&#39;red&#39;</span> <span class="ow">or</span> <span class="n">current_pkg_color</span> <span class="o">==</span> <span class="s1">&#39;yellow&#39;</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="n">ur5_2</span><span class="o">.</span><span class="n">time_lapsed_since_dispatch</span> <span class="o">&lt;</span> <span class="mf">4.1</span><span class="p">:</span>
            <span class="n">appropriate_home_pose</span> <span class="o">=</span> <span class="s1">&#39;home_1&#39;</span>
        <span class="k">elif</span> <span class="n">current_pkg_color</span> <span class="o">==</span> <span class="s1">&#39;green&#39;</span><span class="p">:</span>
            <span class="n">appropriate_home_pose</span> <span class="o">=</span> <span class="s1">&#39;home_3&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">appropriate_home_pose</span> <span class="o">=</span> <span class="s1">&#39;home_2&#39;</span>

    <span class="k">return</span> <span class="n">appropriate_home_pose</span></div>


<div class="viewcode-block" id="go_to_home_position"><a class="viewcode-back" href="../rst/pkg_task5/scripts/node_ur5_2_place.html#node_ur5_2_place.go_to_home_position">[docs]</a><span class="k">def</span> <span class="nf">go_to_home_position</span><span class="p">(</span><span class="n">appropriate_home_pose</span><span class="p">,</span> <span class="n">current_pkg_color</span><span class="p">,</span> <span class="n">prev_bin</span><span class="p">,</span> <span class="n">ur5_2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Move the UR5#2 arm to the appropriate home position to wait for the next package.</span>

<span class="sd">    :param appropriate_home_pose: Home pose to go to</span>
<span class="sd">    :type appropriate_home_pose: str</span>
<span class="sd">    :param current_pkg_color: Colour of the package coming on the conveyor belt</span>
<span class="sd">    :type current_pkg_color: str</span>
<span class="sd">    :param prev_bin: Colour of the bin in which the last package was dropped</span>
<span class="sd">    :type prev_bin: str</span>
<span class="sd">    :param ur5_2: Object of class Ur5Moveit to control UR5#2 arm</span>
<span class="sd">    :type ur5_2: Object of class Ur5Moveit.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">appropriate_home_pose</span> <span class="o">==</span> <span class="s1">&#39;home_1&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Home position #1&quot;</span><span class="p">)</span>
        <span class="n">ur5_2</span><span class="o">.</span><span class="n">home</span> <span class="o">=</span> <span class="s1">&#39;home_1&#39;</span>
        <span class="n">ur5_2</span><span class="o">.</span><span class="n">home_position_updated</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">ur5_2</span><span class="o">.</span><span class="n">hard_play_saved_trajectory</span><span class="p">(</span><span class="n">ur5_2</span><span class="o">.</span><span class="n">get_file_path</span><span class="p">(),</span> <span class="n">prev_bin</span> <span class="o">+</span> <span class="s1">&#39;_bin_to_home_1.yaml&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">appropriate_home_pose</span> <span class="o">==</span> <span class="s1">&#39;home_2&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Home position #2&quot;</span><span class="p">)</span>
        <span class="n">ur5_2</span><span class="o">.</span><span class="n">home</span> <span class="o">=</span> <span class="s1">&#39;home_2&#39;</span>
        <span class="n">ur5_2</span><span class="o">.</span><span class="n">home_position_updated</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">ur5_2</span><span class="o">.</span><span class="n">hard_play_saved_trajectory</span><span class="p">(</span><span class="n">ur5_2</span><span class="o">.</span><span class="n">get_file_path</span><span class="p">(),</span> <span class="n">prev_bin</span> <span class="o">+</span> <span class="s1">&#39;_bin_to_home_2.yaml&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">appropriate_home_pose</span> <span class="o">==</span> <span class="s1">&#39;home_3&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Home position #3&quot;</span><span class="p">)</span>
        <span class="n">ur5_2</span><span class="o">.</span><span class="n">home</span> <span class="o">=</span> <span class="s1">&#39;home_3&#39;</span>
        <span class="n">ur5_2</span><span class="o">.</span><span class="n">home_position_updated</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">ur5_2</span><span class="o">.</span><span class="n">hard_play_saved_trajectory</span><span class="p">(</span><span class="n">ur5_2</span><span class="o">.</span><span class="n">get_file_path</span><span class="p">(),</span> <span class="n">prev_bin</span> <span class="o">+</span> <span class="s1">&#39;_bin_to_home_3.yaml&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">current_pkg_color</span> <span class="o">==</span> <span class="s1">&#39;green&#39;</span><span class="p">:</span>
            <span class="n">ur5_2</span><span class="o">.</span><span class="n">home</span> <span class="o">=</span> <span class="s1">&#39;home_3&#39;</span>
            <span class="n">ur5_2</span><span class="o">.</span><span class="n">home_position_updated</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">ur5_2</span><span class="o">.</span><span class="n">hard_play_saved_trajectory</span><span class="p">(</span><span class="n">ur5_2</span><span class="o">.</span><span class="n">get_file_path</span><span class="p">(),</span> <span class="s1">&#39;home_1_to_home_3.yaml&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ur5_2</span><span class="o">.</span><span class="n">home</span> <span class="o">=</span> <span class="s1">&#39;home_1&#39;</span>
            <span class="n">ur5_2</span><span class="o">.</span><span class="n">home_position_updated</span> <span class="o">=</span> <span class="kc">True</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Rahul, Team Leader VB#0574.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>